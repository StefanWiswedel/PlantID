<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1a">
<title>Flora Sjælland</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300..600;1,9..40,300..600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;--sf:#fff;--tx:#1a1a1a;--tx2:#6b6b6b;--tx3:#a0a0a0;
  --ac:#2d6a4f;--acl:#e8f5e9;--ac2:#40916c;
  --wm:#c4633f;--wml:#fef0ec;
  --bd:rgba(0,0,0,.06);
  --fs:'Instrument Serif',serif;--fb:'DM Sans',sans-serif;
  --sb:env(safe-area-inset-bottom,0px);--st:env(safe-area-inset-top,0px);
  --th:60px;--rad:14px;
}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:var(--fb);color:var(--tx);background:var(--bg);-webkit-font-smoothing:antialiased;overflow-x:hidden;overscroll-behavior-y:contain}
button{font-family:inherit;border:none;background:none;cursor:pointer;color:inherit;-webkit-tap-highlight-color:transparent}
img{display:block;max-width:100%}
#app{min-height:100dvh;padding-bottom:calc(var(--th) + var(--sb) + 8px)}

/* === TABS === */
.tabs{position:fixed;bottom:0;left:0;right:0;z-index:900;background:rgba(248,247,244,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--bd);padding-bottom:var(--sb);display:flex;height:calc(var(--th) + var(--sb))}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;font-size:.62rem;font-weight:500;letter-spacing:.04em;color:var(--tx3);transition:color .15s;padding-top:6px}
.tab.on{color:var(--ac)}
.tab svg{width:22px;height:22px;stroke-width:1.7}
.tab-ic{position:relative}
.badge{position:absolute;top:-5px;right:-9px;background:var(--wm);color:#fff;font-size:.52rem;font-weight:600;min-width:15px;height:15px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px}

/* === VIEWS === */
.v{display:none;min-height:100dvh}.v.on{display:block;animation:vIn .25s ease}
@keyframes vIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* === BROWSE === */
.bh{padding:calc(var(--st) + 20px) 20px 0}
.logo{font-family:var(--fs);font-size:2rem;letter-spacing:-.02em;line-height:1.1}
.logo i{font-style:italic;color:var(--ac)}
.bsub{color:var(--tx2);font-size:.82rem;margin-top:4px;font-weight:300}
.pills{display:flex;gap:8px;padding:18px 20px 14px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.pills::-webkit-scrollbar{display:none}
.pill{flex-shrink:0;padding:8px 16px;border-radius:100px;font-size:.78rem;font-weight:500;background:transparent;color:var(--tx2);border:1.5px solid rgba(0,0,0,.08);transition:all .15s;white-space:nowrap}
.pill.on{background:var(--ac);color:#fff;border-color:var(--ac)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 10px 24px}
.card{position:relative;overflow:hidden;cursor:pointer;background:var(--sf);border-radius:var(--rad);-webkit-tap-highlight-color:transparent;box-shadow:0 1px 4px rgba(0,0,0,.05);transition:transform .15s}
.card:active{transform:scale(.97)}
.card-img{aspect-ratio:3/4;background:#e8e6e1;position:relative;overflow:hidden;border-radius:var(--rad) var(--rad) 0 0}
.card-img img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .35s}
.card-img img.ld{opacity:1}
.skel{position:absolute;inset:0;background:linear-gradient(110deg,#e8e6e1 30%,#f0eee9 50%,#e8e6e1 70%);background-size:200% 100%;animation:shim 1.4s infinite}
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
.card-txt{padding:10px 12px 12px}
.card-nm{font-size:.84rem;font-weight:500;line-height:1.2}
.card-la{font-size:.72rem;color:var(--tx2);font-style:italic;margin-top:2px;font-weight:300}
.card-ck{position:absolute;top:8px;right:8px;width:26px;height:26px;border-radius:50%;background:var(--wm);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.18)}
.card-ck svg{width:13px;height:13px;color:#fff;stroke-width:2.5}

/* === DETAIL === */
.det{position:fixed;inset:0;z-index:950;background:var(--bg);overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}
.det.on{display:block;animation:dIn .3s ease}
@keyframes dIn{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}
.det-x{position:fixed;top:calc(var(--st) + 12px);left:14px;z-index:960;width:38px;height:38px;border-radius:50%;background:rgba(0,0,0,.35);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;transition:transform .15s}
.det-x:active{transform:scale(.88)}
.det-x svg{width:20px;height:20px;color:#fff;stroke-width:2}
.car{position:relative;width:100%;overflow:hidden}
.car-t{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.car-t::-webkit-scrollbar{display:none}
.car-s{flex:0 0 100%;scroll-snap-align:start;aspect-ratio:3/4;background:#e0ddd6;position:relative}
.car-s img{width:100%;height:100%;object-fit:cover}
.car-d{display:flex;gap:5px;justify-content:center;padding:12px 0 4px}
.car-dot{width:7px;height:7px;border-radius:50%;background:var(--tx3);opacity:.25;transition:all .2s}
.car-dot.on{opacity:1;background:var(--ac);transform:scale(1.3)}
.car-lbl{position:absolute;bottom:14px;left:14px;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);color:#fff;font-size:.66rem;font-weight:500;padding:4px 10px;border-radius:100px;text-transform:capitalize;letter-spacing:.02em}
.car-ct{position:absolute;bottom:14px;right:14px;background:rgba(0,0,0,.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);color:#fff;font-size:.66rem;font-weight:500;padding:4px 10px;border-radius:100px}
.det-b{padding:22px 20px 48px}
.det-g{display:inline-block;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;padding:5px 12px;border-radius:100px;margin-bottom:12px}
.det-en{font-family:var(--fs);font-size:1.9rem;line-height:1.15;letter-spacing:-.01em}
.det-la{font-size:.95rem;font-style:italic;color:var(--tx2);margin-top:3px;font-weight:300}
.det-da{font-size:.82rem;color:var(--tx2);margin-top:5px}

/* Sighting button */
.spot-area{margin-top:18px;display:flex;flex-direction:column;gap:10px}
.spot-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:var(--rad);font-size:.85rem;font-weight:500;transition:all .2s}
.spot-primary{background:var(--ac);color:#fff}
.spot-primary:active{background:var(--ac2);transform:scale(.98)}
.spot-count{font-size:.8rem;color:var(--tx2);text-align:center}
.spot-count strong{color:var(--wm);font-weight:600}

/* Sightings timeline in detail */
.sight-list{margin-top:12px}
.sight-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--bd)}
.sight-item:last-child{border-bottom:none}
.sight-icon{width:36px;height:36px;border-radius:10px;background:var(--acl);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--ac)}
.sight-info{flex:1;min-width:0}
.sight-date{font-size:.82rem;font-weight:500}
.sight-loc{font-size:.74rem;color:var(--tx2);margin-top:2px}
.sight-note{font-size:.76rem;color:var(--tx2);margin-top:3px;font-style:italic}
.sight-del{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--tx3);flex-shrink:0}
.sight-del:active{background:var(--wml);color:var(--wm)}

.det-m{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px}
.meta{background:var(--sf);border-radius:var(--rad);padding:13px 14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.meta-l{font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);font-weight:500}
.meta-v{font-size:.86rem;margin-top:3px;font-weight:500}
.sect{margin-top:28px}
.sect-t{font-size:.64rem;text-transform:uppercase;letter-spacing:.1em;color:var(--tx2);font-weight:600;margin-bottom:10px}
.sect p,.sect li{font-size:.88rem;line-height:1.65;color:#3a3a3a}
.sect ul{list-style:none}
.sect li{padding:5px 0 5px 16px;position:relative}
.sect li::before{content:'';position:absolute;left:0;top:13px;width:5px;height:5px;border-radius:50%;background:var(--ac);opacity:.35}
.conf{background:var(--sf);border-radius:var(--rad);padding:14px 16px;margin-top:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.conf-n{font-weight:500;font-size:.85rem}
.conf-d{font-size:.82rem;color:var(--tx2);margin-top:4px;line-height:1.55}

/* === IDENTIFY VIEW (TREE) === */
.ih{padding:calc(var(--st) + 20px) 20px 0}
.it{font-family:var(--fs);font-size:1.7rem}
.it-sub{color:var(--tx2);font-size:.82rem;margin-top:4px;font-weight:300}
.ii{text-align:center;padding:48px 24px}
.ii p{color:var(--tx2);font-size:.88rem;margin-top:8px;max-width:300px;margin-inline:auto;line-height:1.5}
.is{display:inline-flex;align-items:center;gap:8px;margin-top:24px;padding:14px 28px;border-radius:100px;background:var(--ac);color:#fff;font-size:.88rem;font-weight:500;transition:transform .15s}
.is:active{transform:scale(.96)}

/* Tree path */
.tree-wrap{padding:20px 16px 40px}
.tree-restart{display:inline-flex;align-items:center;gap:6px;font-size:.78rem;color:var(--tx2);margin-bottom:16px;padding:6px 12px;border-radius:100px;border:1px solid var(--bd)}
.tree-restart:active{background:var(--acl);color:var(--ac)}

/* Answered steps */
.tree-step{position:relative;padding-left:32px;padding-bottom:4px;margin-bottom:4px}
.tree-step::before{content:'';position:absolute;left:9px;top:20px;bottom:-4px;width:2px;background:var(--ac);opacity:.2}
.tree-step:last-child::before{display:none}
.tree-step .tree-dot{position:absolute;left:2px;top:6px;width:16px;height:16px;border-radius:50%;background:var(--acl);border:2px solid var(--ac)}
.tree-step-q{font-size:.76rem;color:var(--tx2);line-height:1.3;margin-bottom:3px}
.tree-step-a{font-size:.84rem;font-weight:500;color:var(--ac);line-height:1.3;padding:4px 0 8px}

/* Current question */
.tree-current{position:relative;padding-left:32px;margin-top:4px}
.tree-current .tree-dot{position:absolute;left:2px;top:6px;width:16px;height:16px;border-radius:50%;background:var(--ac);box-shadow:0 0 0 4px var(--acl)}
.tree-q{font-family:var(--fs);font-size:1.15rem;line-height:1.35;margin-bottom:14px;color:var(--tx)}

/* Branch options */
.tree-options{display:flex;flex-direction:column;gap:8px}
.tree-options.binary{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tree-opt{text-align:left;padding:14px 16px;border:2px solid var(--bd);border-radius:var(--rad);font-size:.84rem;line-height:1.45;background:var(--sf);transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.tree-opt:active{border-color:var(--ac);background:var(--acl);transform:scale(.97)}

/* Result */
.tree-result{position:relative;padding-left:32px;margin-top:4px}
.tree-result .tree-dot{position:absolute;left:2px;top:6px;width:16px;height:16px;border-radius:50%;background:var(--wm);box-shadow:0 0 0 4px var(--wml)}
.kr{text-align:center;padding:8px 0 20px}
.kr-l{font-size:.64rem;text-transform:uppercase;letter-spacing:.1em;color:var(--tx2);font-weight:600}
.kr-n{font-family:var(--fs);font-size:1.6rem;margin-top:6px}
.kr-la{font-style:italic;color:var(--tx2);font-weight:300}
.kri{width:140px;height:140px;border-radius:50%;margin:20px auto;background:#e0ddd6;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.1)}
.kri img{width:100%;height:100%;object-fit:cover}
.kr-btns{display:flex;gap:10px;justify-content:center;margin-top:18px;flex-wrap:wrap}
.kr-btns button{padding:12px 22px;border-radius:100px;font-size:.84rem;font-weight:500;transition:transform .15s}
.kr-btns button:active{transform:scale(.96)}
.bp{background:var(--ac);color:#fff}.bs{border:1.5px solid var(--bd);color:var(--tx)}

/* === FIELD LOG === */
.mh{padding:calc(var(--st) + 20px) 20px 0}
.mc{font-family:var(--fs);font-size:2.8rem;color:var(--ac);line-height:1}
.mc small{font-size:.88rem;color:var(--tx2);font-weight:300;font-family:var(--fb)}
.pw{margin:14px 20px 4px;height:5px;background:rgba(0,0,0,.05);border-radius:3px;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:3px;transition:width .4s ease}
.mhn{font-size:.78rem;color:var(--tx2);padding:0 20px;margin-bottom:8px;font-weight:300}
.log-tabs{display:flex;gap:0;padding:8px 20px 12px}
.log-tab{flex:1;padding:10px;text-align:center;font-size:.8rem;font-weight:500;color:var(--tx2);border-bottom:2px solid transparent;transition:all .15s}
.log-tab.on{color:var(--ac);border-bottom-color:var(--ac)}
.me{text-align:center;padding:48px 24px}
.me p{color:var(--tx2);font-size:.88rem;margin-top:8px;line-height:1.5}
.mr{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:background .1s}
.mr:active{background:rgba(0,0,0,.03)}
.mth{width:48px;height:48px;border-radius:12px;background:#e0ddd6;overflow:hidden;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.mth img{width:100%;height:100%;object-fit:cover}
.mi{flex:1;min-width:0}
.mn{font-size:.86rem;font-weight:500}
.mla{font-size:.74rem;color:var(--tx2);font-style:italic;font-weight:300}
.msub{font-size:.72rem;color:var(--tx3);margin-top:2px}
.mrm{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--tx3);flex-shrink:0}
.mrm:active{background:var(--wml);color:var(--wm)}
.ph{display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:.72rem;color:var(--tx3);font-style:italic;text-align:center;padding:8px}

/* Map button in field log */
.map-all-btn{display:flex;align-items:center;justify-content:center;gap:8px;margin:8px 20px 16px;padding:12px;border-radius:var(--rad);border:1.5px solid var(--bd);font-size:.84rem;font-weight:500;color:var(--ac);transition:all .15s}
.map-all-btn:active{background:var(--acl);transform:scale(.98)}

/* === SIGHTING MODAL === */
.modal-overlay{position:fixed;inset:0;z-index:970;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center}
.modal-overlay.on{display:flex;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-sheet{width:100%;max-width:500px;max-height:92vh;background:var(--bg);border-radius:20px 20px 0 0;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;border-radius:2px;background:rgba(0,0,0,.12);margin:10px auto 0}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px}
.modal-title{font-family:var(--fs);font-size:1.2rem}
.modal-close{width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center}
.modal-close svg{width:16px;height:16px;stroke-width:2.5}
.modal-body{padding:0 20px 32px}
#sight-map{width:100%;height:220px;border-radius:var(--rad);overflow:hidden;margin-bottom:16px;z-index:0}
.form-row{margin-bottom:14px}
.form-label{font-size:.72rem;text-transform:uppercase;letter-spacing:.06em;color:var(--tx2);font-weight:500;margin-bottom:6px;display:block}
.form-input{width:100%;padding:11px 14px;border:1.5px solid var(--bd);border-radius:10px;font-family:inherit;font-size:.86rem;background:var(--sf);color:var(--tx);transition:border-color .15s}
.form-input:focus{outline:none;border-color:var(--ac)}
.form-save{width:100%;padding:14px;border-radius:var(--rad);background:var(--ac);color:#fff;font-size:.88rem;font-weight:500;margin-top:8px;transition:transform .15s}
.form-save:active{transform:scale(.98);background:var(--ac2)}

/* Full map modal */
.map-modal{position:fixed;inset:0;z-index:960;background:var(--bg);display:none}
.map-modal.on{display:block;animation:vIn .25s ease}
.map-modal-head{position:absolute;top:0;left:0;right:0;z-index:1000;display:flex;align-items:center;gap:12px;padding:calc(var(--st) + 12px) 16px 12px;background:rgba(248,247,244,.92);backdrop-filter:blur(16px)}
.map-modal-head h2{font-family:var(--fs);font-size:1.2rem;flex:1}
#full-map{width:100%;height:100%}

/* Leaflet popup overrides */
.leaflet-popup-content-wrapper{border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.leaflet-popup-content{font-family:var(--fb);font-size:.82rem;margin:10px 14px}
.leaflet-popup-content strong{font-weight:600}
</style>
</head>
<body>
<div id="app">
  <div class="v on" id="v-browse">
    <div class="bh"><div class="logo">Flora <i>Sjælland</i></div><p class="bsub">20 common trees &amp; shrubs of Zealand</p></div>
    <div class="pills" id="pills"></div>
    <div class="grid" id="grid"></div>
  </div>
  <div class="v" id="v-identify">
    <div class="ih"><h1 class="it">Identify</h1><p class="it-sub">Follow the branching key to identify your tree</p></div>
    <div id="idc"><div class="ii"><p>Answer step-by-step questions to narrow down the species.</p><button class="is" onclick="startKey()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35" stroke-linecap="round"/></svg>Begin Identification</button></div></div>
  </div>
  <div class="v" id="v-fieldlog">
    <div class="mh"><div class="logo">Field <i>Log</i></div></div>
    <div id="mlc"></div>
  </div>
</div>
<div class="det" id="det">
  <button class="det-x" onclick="closeDet()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
  <div id="di"></div>
</div>

<!-- Sighting modal -->
<div class="modal-overlay" id="sight-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-head">
      <h3 class="modal-title">Log Sighting</h3>
      <button class="modal-close" onclick="closeSightModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    </div>
    <div class="modal-body">
      <div id="sight-map"></div>
      <div class="form-row"><label class="form-label">Date & Time</label><input type="datetime-local" class="form-input" id="sight-dt"></div>
      <div class="form-row"><label class="form-label">Notes (optional)</label><input type="text" class="form-input" id="sight-note" placeholder="e.g. Large specimen near the lake"></div>
      <button class="form-save" id="sight-save" onclick="saveSighting()">Save Sighting</button>
    </div>
  </div>
</div>

<!-- Full map modal -->
<div class="map-modal" id="map-modal">
  <div class="map-modal-head">
    <button class="det-x" style="position:static;width:36px;height:36px" onclick="closeMapModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    <h2>All Sightings</h2>
  </div>
  <div id="full-map"></div>
</div>

<nav class="tabs" id="tabs">
  <button class="tab on" data-v="browse" onclick="go('browse')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Browse</button>
  <button class="tab" data-v="identify" onclick="go('identify')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v6m0 0l-3-3m3 3l3-3" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6" cy="15" r="3"/><circle cx="18" cy="15" r="3"/><path d="M12 9v3m0 0l-3.5 1.5M12 12l3.5 1.5" stroke-linecap="round"/></svg>Identify</button>
  <button class="tab" data-v="fieldlog" onclick="go('fieldlog')"><span class="tab-ic"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg><span class="badge" id="badge" style="display:none">0</span></span>Field Log</button>
</nav>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================================================================
// SPECIES DATA
// ================================================================
const GRP=[
{id:'broadleaf',name:'Indigenous Broadleaf',fg:'#2d5a27',bg:'#eaf2e8'},
{id:'conifer',name:'Conifers',fg:'#3d6b5e',bg:'#e5f0ec'},
{id:'intro',name:'Introduced & Planted',fg:'#7a5c2e',bg:'#f5efe5'},
{id:'shrub',name:'Shrubs & Small Trees',fg:'#6e3d5b',bg:'#f3e8ee'}
];
const SP=[
{id:'fagus-sylvatica',la:'Fagus sylvatica',en:'European Beech',da:'Bøg',g:'broadleaf',ht:'25–40 m',life:'300–400 yr',hab:'Dominant forest tree on well-drained, fertile soils throughout Sjælland. Prefers slightly acidic to calcareous ground.',feat:['Smooth silver-grey bark that remains smooth even on old trees','Oval leaves 5–10 cm with wavy (not toothed) margins, silky-hairy when young','Buds long (15–20 mm), sharply pointed, cigar-shaped, copper-brown','Fruit: triangular nuts (beech mast) in pairs inside a spiny 4-valved husk','Dense canopy casting deep shade; little understorey'],season:'Leaves emerge pale green April–May, turn golden-copper in autumn. Dead leaves persist on young trees through winter (marcescence).',conf:[{sp:'Carpinus betulus (Hornbeam)',d:'Hornbeam has doubly serrate (toothed) leaf margins and a fluted/ridged trunk; beech has wavy-edged leaves and always-smooth bark.'}]},
{id:'quercus-robur',la:'Quercus robur',en:'Pedunculate Oak',da:'Stilk-eg',g:'broadleaf',ht:'20–35 m',life:'500–1000+ yr',hab:'Mixed forests, hedgerows, parkland. Tolerates heavy clay. Very common across Sjælland.',feat:['Deeply lobed leaves with 4–5 rounded lobe pairs; very short petiole (<5 mm)','Bark deeply fissured into rough vertical ridges on mature trees','Acorns on long stalks (peduncles) 3–7 cm — the key diagnostic','Clustered buds at twig tips, ovoid, orange-brown','Branches often gnarled; irregular crown on old specimens'],season:'Late to leaf out (May). Brown autumn leaves may persist on young trees. Acorns ripen September–October.',conf:[{sp:'Quercus petraea (Sessile Oak)',d:'Sessile oak has longer leaf stalks (1–2 cm) and acorns sitting directly on the twig without peduncles. Rarer on Sjælland.'}]},
{id:'betula-pendula',la:'Betula pendula',en:'Silver Birch',da:'Vortebirk',g:'broadleaf',ht:'15–25 m',life:'60–90 yr',hab:'Pioneer species on sandy, acidic, or disturbed soils. Heathland edges, roadsides, open woodland.',feat:['White papery bark peeling in horizontal strips; base becomes black and fissured with age','Small triangular-rhombic leaves (3–7 cm), doubly serrate margins','Twigs slender, pendulous (hanging), with small warty resin glands','Male catkins pendulous, 3–6 cm; female catkins smaller, upright then drooping','Light, airy crown — never dense shade'],season:'Among the first trees to leaf out in spring. Yellow autumn colour. Male catkins visible from autumn through winter.',conf:[{sp:'Betula pubescens (Downy Birch)',d:'Downy birch has hairy (not warty) young twigs, more rounded leaves, greyer bark, and prefers wetter soils.'}]},
{id:'fraxinus-excelsior',la:'Fraxinus excelsior',en:'European Ash',da:'Ask',g:'broadleaf',ht:'20–35 m',life:'200–300 yr',hab:'Fertile moist soils; forests, hedgerows. Common but declining due to ash dieback (Hymenoscyphus fraxineus).',feat:['Compound pinnate leaves with 7–13 leaflets, opposite arrangement on the twig','Distinctive jet-black buds — very reliable winter ID feature','Bark smooth and pale grey when young, developing shallow fissures with age','Winged seeds (keys) in dense hanging clusters, single-winged','Last native tree to leaf out in spring; first to drop leaves in autumn'],season:'Leafs out late May. Seeds persist into winter. Black buds are the best year-round ID.',conf:[{sp:'Sorbus aucuparia (Rowan)',d:'Rowan also has pinnate leaves but leaflets are smaller (3–6 cm), sharply toothed, alternate on branch; buds purple-grey and hairy, not black.'}]},
{id:'tilia-cordata',la:'Tilia cordata',en:'Small-leaved Lime',da:'Småbladet lind',g:'broadleaf',ht:'20–30 m',life:'500–1000+ yr',hab:'Mixed deciduous forests on fertile soils. Also widely planted as a street and park tree.',feat:['Heart-shaped leaves 3–8 cm with pointed tip and asymmetric base','Underside has characteristic orange-brown hair tufts in vein axils','Bark smooth grey when young, finely fissured with age','Fragrant yellowish flowers in clusters hanging from a wing-like bract (July)','Small round fruits (4–6 mm), thin-walled, without prominent ribs'],season:'Fragrant flowering in July attracts abundant insects. Leaves turn yellow in autumn.',conf:[{sp:'Tilia platyphyllos (Large-leaved Lime)',d:'Larger leaves (6–15 cm), white hair tufts beneath (not orange-brown), and ribbed, thick-walled fruits.'}]},
{id:'alnus-glutinosa',la:'Alnus glutinosa',en:'Common Alder',da:'Rødel',g:'broadleaf',ht:'15–25 m',life:'60–100 yr',hab:'Wet ground: stream banks, bog margins, lakeshores, damp forest. Nitrogen-fixer.',feat:['Rounded leaves 5–10 cm with a notched (retuse) apex — distinctive flat or indented leaf tip','Young leaves and buds are sticky (glutinous)','Small woody cone-like fruits (1–2 cm) persist year-round — key winter ID','Bark dark brown to blackish, fissured into small squares on mature trees','Male catkins purple-stalked, visible from autumn, opening before leaves'],season:'Catkins open February–March. Woody cones persist through winter. Always near water.',conf:[{sp:'Alnus incana (Grey Alder)',d:'Grey alder has pointed (not notched) leaf tips, grey bark, and grey-hairy leaf undersides. Less common on Sjælland.'}]},
{id:'populus-tremula',la:'Populus tremula',en:'Aspen',da:'Bævreasp',g:'broadleaf',ht:'15–25 m',life:'50–100 yr',hab:'Forest edges, clearings, roadsides. Pioneer species. Spreads vigorously by root suckers.',feat:['Rounded leaves 3–8 cm on very long, flattened petioles — leaves tremble in slightest breeze','Leaf margin with blunt rounded teeth (crenate)','Bark smooth greenish-grey; darker and furrowed at base with age','Long grey drooping catkins appear before leaves, March–April','Often forms clonal stands from root suckers'],season:'Trembling leaves audible in summer. Catkins appear early spring. Good golden-yellow autumn colour.',conf:[{sp:'Populus × canescens (Grey Poplar)',d:'Grey poplar leaves are greyish-white and downy beneath. Often larger. Hybrid origin.'}]},
{id:'ulmus-glabra',la:'Ulmus glabra',en:'Wych Elm',da:'Storbladet elm',g:'broadleaf',ht:'20–35 m',life:'200–400 yr',hab:'Mixed forests, hedgerows, ravines. Prefers fertile moist soils. Declining due to Dutch elm disease.',feat:['Large leaves 8–16 cm with markedly asymmetric base — one side extends further down petiole','Leaf surface very rough (sandpapery) with stiff hairs on upper side','Doubly serrate leaf margin','Winged seeds (samaras) with seed in centre of wing; appear before leaves','Buds dark brown, hairy; bark grey-brown, rough fissures'],season:'Flowers and fruits appear March–April before leaves. Leaves turn yellow in autumn.',conf:[{sp:'Ulmus minor (Field Elm)',d:'Field elm has smaller, smoother, glossy leaves with less pronounced asymmetry. Suckering habit. Very rare on Sjælland.'}]},
{id:'picea-abies',la:'Picea abies',en:'Norway Spruce',da:'Rødgran',g:'conifer',ht:'30–50 m',life:'200–400 yr',hab:'Widely planted forestry species. Not native to Denmark but naturalised. Traditional Danish Christmas tree.',feat:['Needles short (1–2.5 cm), stiff, pointed, singly attached all around the twig','Twig rough with small woody pegs when needles removed — key diagnostic vs fir','Cones pendulous, large (10–18 cm), cylindrical, hanging down','Bark reddish-brown, thin, scaly','Regular conical crown with drooping side-branches'],season:'Evergreen. Light green new growth ("candles") in May. Cones ripen autumn.',conf:[{sp:'Abies (Fir species)',d:'Firs have flat needles with two white stripes beneath, smooth bark with resin blisters, and upright cones that disintegrate on the tree.'}]},
{id:'pinus-sylvestris',la:'Pinus sylvestris',en:'Scots Pine',da:'Skovfyr',g:'conifer',ht:'20–35 m',life:'150–300 yr',hab:'Sandy soils, heathland, planted forests. Widely planted on Sjælland.',feat:['Needles in pairs, 3–7 cm long, twisted, blue-green','Upper bark distinctive orange-red, flaking in thin plates — visible from distance','Lower trunk bark grey-brown, deeply fissured','Small ovoid cones (3–7 cm), green ripening to grey-brown','Mature trees develop flat-topped or irregular crown, not conical'],season:'Evergreen. Orange upper bark visible year-round. Old needles shed in autumn (normal).',conf:[{sp:'Pinus nigra (Black Pine)',d:'Black pine has much longer needles (10–15 cm), stiffer, not twisted, darker green. Bark uniformly grey-brown without orange upper trunk.'}]},
{id:'larix-decidua',la:'Larix decidua',en:'European Larch',da:'Europæisk lærk',g:'conifer',ht:'25–40 m',life:'200–300 yr',hab:'Planted in forests and parks. Native to the Alps, introduced to Denmark for forestry.',feat:['Deciduous conifer — the only common conifer that loses needles in winter','Needles soft, light green, 2–4 cm, in rosette-like clusters of 30–40 on short shoots','Small upright cones (2–4 cm), ovoid, persisting on branches for years','Bark grey-brown developing deep fissures and pinkish inner bark','Crown conical when young, broader with age'],season:'Bright fresh green needles in spring; golden-yellow before falling October–November. Bare branches with small cones in winter diagnostic.',conf:[{sp:'Larix kaempferi (Japanese Larch)',d:'Japanese larch has blue-green (glaucous) needles, slightly larger cones with recurved scale tips, reddish-brown twigs.'}]},
{id:'acer-platanoides',la:'Acer platanoides',en:'Norway Maple',da:'Spidsløn',g:'intro',ht:'20–30 m',life:'150–250 yr',hab:'Forests, parks, streets. Native to eastern Denmark including parts of Sjælland; also very widely planted.',feat:['Leaves with 5 sharply pointed lobes, few large teeth, 10–15 cm wide','Milky sap when leaf petiole is broken — key diagnostic vs sycamore','Bright yellow-green flower clusters appear before leaves in April','Winged seed pairs (samaras) spread at obtuse angle (nearly 180°)','Bark grey, shallow interlacing ridges (not flaking)'],season:'Conspicuous yellow-green flowers April. Excellent yellow autumn colour. Samaras ripen autumn.',conf:[{sp:'Acer pseudoplatanus (Sycamore)',d:'Sycamore has blunter leaf lobes, coarser teeth, no milky sap from petiole, drooping flower clusters (not erect), samaras at more acute angle.'}]},
{id:'acer-pseudoplatanus',la:'Acer pseudoplatanus',en:'Sycamore Maple',da:'Ahorn',g:'intro',ht:'20–35 m',life:'200–400 yr',hab:'Widely planted in parks, gardens, shelter belts. Naturalised, sometimes invasive. Not native to Denmark.',feat:['Large 5-lobed leaves 10–25 cm wide, lobes with coarse irregular blunt teeth','No milky sap when petiole is broken (unlike Norway maple)','Bark grey, smooth when young, developing large flaking plates revealing pink-brown inner bark','Pendulous flower racemes April–May, after leaf emergence','Winged seed pairs at acute angle (approx. 60–90°)'],season:'Leaves emerge reddish. Often just turns brown in autumn. Flaking bark diagnostic on mature trees.',conf:[{sp:'Acer platanoides (Norway Maple)',d:'Norway maple has sharply pointed lobes, milky sap from petiole, erect yellow-green flower clusters before leaves, widely spread samaras.'}]},
{id:'aesculus-hippocastanum',la:'Aesculus hippocastanum',en:'Horse Chestnut',da:'Hestekastanje',g:'intro',ht:'20–30 m',life:'200–300 yr',hab:'Parks, avenues, gardens. Native to the Balkans, widely planted across Denmark.',feat:['Large palmate compound leaves with 5–7 leaflets radiating from single point, leaflets 10–25 cm','Very large sticky buds — among the most recognisable winter features of any tree','Upright conical flower "candles" in May, white with pink/yellow markings','Fruit: spiny green husk containing 1–2 glossy brown conkers','Bark grey-brown, scaly, peeling in irregular plates'],season:'Leaf out and flowering May. Conkers fall September–October. Sticky buds key winter ID. Often shows leaf miner damage by midsummer.',conf:[{sp:'Aesculus × carnea (Red Horse Chestnut)',d:'Red horse chestnut has pink-red flowers, smaller leaves. Hybrid, less commonly planted.'}]},
{id:'carpinus-betulus',la:'Carpinus betulus',en:'European Hornbeam',da:'Avnbøg',g:'intro',ht:'15–25 m',life:'150–300 yr',hab:'Mixed deciduous forests, hedgerows. Native to eastern Denmark including Sjælland. Also widely planted as hedging.',feat:['Oval leaves 5–10 cm with prominent parallel veins, doubly serrate margins','Bark smooth grey with distinctive fluted (muscular) trunk — key diagnostic','Fruit: small nutlet attached to three-lobed leafy bract, in hanging clusters','Buds slender, appressed to twig, shorter than beech buds','Leaves strongly resemble beech but always have clear serrations'],season:'Retains dead brown leaves through winter (marcescence). Fruits ripen autumn. Fluted trunk visible year-round.',conf:[{sp:'Fagus sylvatica (Beech)',d:'Beech has smooth (never fluted) trunk, wavy (not serrate) leaf margins, longer sharper buds. Beech nuts triangular in spiny husk, not winged.'}]},
{id:'sorbus-aucuparia',la:'Sorbus aucuparia',en:'Rowan',da:'Røn',g:'shrub',ht:'8–15 m',life:'60–100 yr',hab:'Forest edges, clearings, rocky ground, heathland, gardens. Tolerates poor acidic soils.',feat:['Pinnate leaves with 9–15 small leaflets (3–6 cm each), sharply toothed','Alternate leaf arrangement (vs opposite in ash)','Dense clusters of creamy-white flowers May–June','Bright red-orange berry clusters August–September — very conspicuous','Bark smooth shiny grey-silver; buds purple-grey with grey hairs'],season:'Red berries from August. Flowers May–June. Good yellow-red autumn colour.',conf:[{sp:'Fraxinus excelsior (Ash)',d:'Ash has fewer, larger leaflets (5–12 cm), opposite arrangement, black buds, winged seeds not berries. Much larger tree.'}]},
{id:'prunus-avium',la:'Prunus avium',en:'Wild Cherry',da:'Fuglekirsebær',g:'shrub',ht:'15–25 m',life:'60–100 yr',hab:'Mixed forests, hedgerows, forest edges on fertile soils. Common on Sjælland.',feat:['Bark reddish-brown with prominent horizontal lenticels — peels in horizontal strips','Leaves oval 6–15 cm, serrate margins; two red glands at petiole top','White flowers in clusters of 2–6 on long stalks, with leaves, April–May','Small red to dark red cherries June–July','Autumn colour often excellent — red, orange, yellow'],season:'White blossom April–May. Cherries ripen June–July. Distinctive bark year-round.',conf:[{sp:'Prunus padus (Bird Cherry)',d:'Bird cherry has flowers in elongated racemes (not short clusters), smaller leaves, grey-brown bark without prominent lenticels, unpleasant bark smell.'}]},
{id:'prunus-padus',la:'Prunus padus',en:'Bird Cherry',da:'Hæg',g:'shrub',ht:'8–15 m',life:'60–80 yr',hab:'Moist woodlands, stream banks, hedgerows. Prefers damp fertile soils.',feat:['Flowers in elongated drooping racemes (10–15 cm) — key diagnostic; May','Small black bitter cherries in drooping strings','Bark smooth dark grey-brown; unpleasant smell when scratched','Leaves elliptic 6–10 cm, finely toothed, dull upper surface','Buds conical, appressed, dark brown'],season:'Fragrant white blossom in May. Black fruit July–August, quickly eaten by birds.',conf:[{sp:'Prunus avium (Wild Cherry)',d:'Wild cherry has flowers in short clusters (not racemes), reddish bark with horizontal bands, red (not black) larger cherries.'}]},
{id:'salix-caprea',la:'Salix caprea',en:'Goat Willow',da:'Seljepil',g:'shrub',ht:'6–12 m',life:'30–60 yr',hab:'Forest edges, hedgerows, waste ground. Pioneer species. Common throughout Sjælland.',feat:['Leaves broadly elliptic to almost round (5–10 cm), wrinkled surface, grey woolly underside','Large silvery-furry catkins before leaves in March — "pussy willows"','Male catkins turn bright yellow with pollen; female catkins greener','Twigs stout; bark grey-brown with diamond-shaped fissures','Stipules at leaf base (small ear-shaped appendages)'],season:'Among earliest flowering (March). Catkins important early nectar source. Grey woolly leaf undersides all summer.',conf:[{sp:'Salix cinerea (Grey Willow)',d:'Grey willow has narrower leaves, raised ridges under the bark when stripped, and grows in wetter habitats. Often hybridises.'}]},
{id:'crataegus-monogyna',la:'Crataegus monogyna',en:'Common Hawthorn',da:'Engriflet hvidtjørn',g:'shrub',ht:'4–10 m',life:'200–400 yr',hab:'Hedgerows, scrub, forest edges, pastures. Extremely common. Often planted as hedging.',feat:['Sharp thorns (1–1.5 cm) on branches — key feature','Leaves deeply lobed (3–7 lobes), 2–4 cm, lobes cut more than halfway to midrib','Dense clusters of white (sometimes pink) flowers with a single style, May–June','Dark red haws (berries) with a single stone, September–October','Bark grey-brown, developing orange-brown fissures; gnarled twisted form'],season:'Abundant white "may blossom" in May. Red haws from September. Thorns and gnarled form year-round.',conf:[{sp:'Crataegus laevigata (Midland Hawthorn)',d:'Midland hawthorn has shallower leaf lobes (less than halfway to midrib), 2–3 styles per flower, 2–3 stones per haw.'}]}
];
const KEY={
start:{q:'Does the plant have needles/scales (conifer) or broad flat leaves?',o:[{t:'Needles or scales — conifer',n:'c1'},{t:'Broad flat leaves',n:'b1'}]},
c1:{q:'Does it lose its needles in autumn?',o:[{t:'Yes — soft light green needles in clusters that turn yellow and fall',r:'larix-decidua'},{t:'No — evergreen',n:'c2'}]},
c2:{q:'How are the needles arranged?',o:[{t:'In pairs, 3–7 cm, twisted; upper bark orange-red',r:'pinus-sylvestris'},{t:'Single, short (1–2.5 cm), stiff, all around twig; twig rough when stripped',r:'picea-abies'}]},
b1:{q:'Are the leaves compound (divided into separate leaflets)?',o:[{t:'Yes — distinct leaflets',n:'b2'},{t:'No — single blade (may be lobed)',n:'b5'}]},
b2:{q:'How are the leaflets arranged?',o:[{t:'Radiating from one point like a hand (palmate); large sticky buds',r:'aesculus-hippocastanum'},{t:'In pairs along a central stalk (pinnate)',n:'b3'}]},
b3:{q:'How are the leaves arranged on the branch?',o:[{t:'Opposite pairs; leaflets 5–12 cm; jet-black buds',r:'fraxinus-excelsior'},{t:'Alternate; small leaflets (3–6 cm); red berries in autumn',r:'sorbus-aucuparia'}]},
b5:{q:'Is the leaf clearly lobed (deep indentations)?',o:[{t:'Yes — distinct lobes',n:'b6'},{t:'No — toothed, wavy, or smooth edge',n:'b10'}]},
b6:{q:'What shape are the lobes?',o:[{t:'Pointed star-like lobes; leaves opposite',n:'b7'},{t:'Rounded lobes; leaves alternate',n:'b8'},{t:'Small leaf (2–4 cm) with deep narrow lobes; thorns',r:'crataegus-monogyna'}]},
b7:{q:'Break the leaf stalk. Is there milky sap?',o:[{t:'Yes — milky white sap; sharp-toothed lobes',r:'acer-platanoides'},{t:'No milky sap; blunt-toothed lobes; bark flakes on old trees',r:'acer-pseudoplatanus'}]},
b8:{q:'Examine the lobes and fruit:',o:[{t:'4–5 pairs of rounded lobes; very short leaf stalk; acorns on long stalks',r:'quercus-robur'}]},
b10:{q:'Look at the bark:',o:[{t:'White/silvery, peeling in papery strips',r:'betula-pendula'},{t:'Reddish-brown with horizontal bands',n:'b15'},{t:'Smooth grey',n:'b11'},{t:'Dark, fissured or rough',n:'b13'}]},
b11:{q:'Is the trunk fluted or muscular-looking?',o:[{t:'Yes — fluted ridges; doubly serrate leaves with parallel veins',r:'carpinus-betulus'},{t:'No — smooth round trunk; wavy-edged leaves; long pointed buds',r:'fagus-sylvatica'}]},
b13:{q:'Examine the leaves:',o:[{t:'Markedly asymmetric base; large (8–16 cm); rough sandpapery',r:'ulmus-glabra'},{t:'Heart-shaped; orange-brown hair tufts in vein axils beneath',r:'tilia-cordata'},{t:'Rounded with notched tip; near water; small woody cones',r:'alnus-glutinosa'},{t:'Round on long flattened stalk (trembles); blunt-toothed',r:'populus-tremula'},{t:'Broad elliptic, grey-woolly beneath; early silvery catkins',r:'salix-caprea'}]},
b15:{q:'How are the flowers or fruits arranged?',o:[{t:'Long drooping racemes; black berries; bark smells unpleasant',r:'prunus-padus'},{t:'Short clusters of 2–6; red cherries; red glands on leaf stalk',r:'prunus-avium'}]}
};

// ================================================================
// STATE
// ================================================================
let view='browse',filter='all',imgC={},keyH=[];
// Sightings: array of {id, date, lat, lng, note}
let sightings = JSON.parse(localStorage.getItem('fs-sightings')||'[]');
// Migrate old format
const _oldSeen = JSON.parse(localStorage.getItem('fs-seen')||'[]');
if (_oldSeen.length && !sightings.length) {
  sightings = _oldSeen.map(id=>({id,date:new Date().toISOString(),lat:null,lng:null,note:'Migrated from checklist'}));
  localStorage.setItem('fs-sightings',JSON.stringify(sightings));
}
function getSeenIds(){ return [...new Set(sightings.map(s=>s.id))]; }
function getSightingsFor(id){ return sightings.filter(s=>s.id===id); }
let sightModalSpecies = null;
let sightMap = null, sightMarker = null, fullMap = null;

// ================================================================
// CURATED IMAGES
// ================================================================
let curatedImages = null;
async function loadCuratedImages() {
  if (curatedImages !== null) return;
  try { const r = await fetch('images.json'); if (!r.ok) throw 0; curatedImages = await r.json(); }
  catch { curatedImages = {}; }
}
const curatedReady = loadCuratedImages();

// ================================================================
// IMAGE ENGINE
// ================================================================
const FEAT_MAP = [
  { id:'leaf',   label:'Leaves',        kw: /\b(leaf|leaves|leav|foliage|needle|needles)\b/i },
  { id:'bark',   label:'Bark',          kw: /\b(bark|trunk|rind)\b/i },
  { id:'flower', label:'Flowers',       kw: /\b(flower|flowers|blossom|catkin|infloresc|strobil)\b/i },
  { id:'fruit',  label:'Fruit / Seeds', kw: /\b(fruit|fruits|seed|seeds|cone|cones|acorn|nut|berry|berries|haw|samara|strobil)\b/i },
  { id:'bud',    label:'Buds / Twigs',  kw: /\b(bud|buds|twig|shoot)\b/i },
  { id:'autumn', label:'Autumn colour', kw: /\b(autumn|fall|herbst)\b/i },
];
const SKIP_CAT = /cultivar|illustration|drawing|painting|\bwood\b|timber|fossil|forest|hedge|seedling|root|garden|avenue|street|park[^a-z]|country|region|in\s+(the\s+)?\w+$|purpurea|pendula|asplenifolia|tortuosa|fastigiata|dawyck|zlatia|tricolor|laciniata|rotundifolia|atropurpurea|atropunicea|riversii|dissecta|lutescens|columnaris|disease|pest|gall/i;
const SKIP_FILE = /wood[_ ]|timber|lumber|plank|floor|veneer|board|furniture|fossil|herbarium|microscop|cross[_ -]?section|anatomy|pollen[_ ]grain|painting|drawing|illustration|engraving|historical[_ ]|museum|stamp|coin|logo|icon|map[_ ]|diagram|flag|svg|cultivation|cultivar|purpurea|pendula|asplenifolia|tortuosa|fastigiata|f\.\s?purpurea/i;
const COMMONS = 'https://commons.wikimedia.org/w/api.php';

async function fetchSubcats(name) {
  const url = COMMONS+'?action=query&list=categorymembers&cmtitle=Category:'+encodeURIComponent(name)+'&cmtype=subcat&cmlimit=50&format=json&origin=*';
  const r = await fetch(url); if (!r.ok) return [];
  const d = await r.json();
  return (d.query&&d.query.categorymembers||[]).map(c=>c.title);
}
async function fetchCatFiles(catTitle, limit) {
  const url = COMMONS+'?action=query&generator=categorymembers&gcmtitle='+encodeURIComponent(catTitle)+'&gcmtype=file&gcmlimit='+limit+'&prop=imageinfo&iiprop=url&iiurlwidth=800&format=json&origin=*';
  const r = await fetch(url); if (!r.ok) return [];
  const d = await r.json();
  if (!d.query||!d.query.pages) return [];
  return Object.values(d.query.pages).filter(p=>p.imageinfo&&p.imageinfo[0]&&p.imageinfo[0].thumburl).filter(p=>/\.(jpg|jpeg|png)$/i.test(p.title||'')).filter(p=>!SKIP_FILE.test(p.title||'')).map(p=>p.imageinfo[0].thumburl);
}
async function fetchImgs(la) {
  if (imgC[la]) return imgC[la];
  await curatedReady;
  if (curatedImages && curatedImages[la] && curatedImages[la].length > 0) { imgC[la]=curatedImages[la]; return imgC[la]; }
  const name = la.replace(/ /g,'_');
  try {
    const subcats = await fetchSubcats(name);
    const matched = {};
    for (const cat of subcats) { if (SKIP_CAT.test(cat)) continue; for (const feat of FEAT_MAP) { if (feat.kw.test(cat)&&!matched[feat.id]) { matched[feat.id]=cat; break; } } }
    const tasks = [fetchCatFiles('Category:'+name,20)], taskLabels = ['Whole tree'];
    for (const [fid,catTitle] of Object.entries(matched)) { const feat=FEAT_MAP.find(f=>f.id===fid); tasks.push(fetchCatFiles(catTitle,8)); taskLabels.push(feat?feat.label:fid); }
    const results = await Promise.all(tasks);
    const pool = [], usedUrl = new Set();
    for (let i=1;i<results.length;i++) for (const url of results[i]) if (!usedUrl.has(url)){usedUrl.add(url);pool.push({url,label:taskLabels[i]});}
    for (const url of results[0]) if (!usedUrl.has(url)){usedUrl.add(url);pool.push({url,label:'Whole tree'});}
    if (!pool.length) throw 0;
    const selected=[],usedLabels=new Set(),MAX=12;
    for (const item of pool){if(selected.length>=MAX)break;if(item.label!=='Whole tree'&&!usedLabels.has(item.label)){selected.push(item);usedLabels.add(item.label);}}
    const usedS=new Set(selected.map(s=>s.url));
    for (const item of pool){if(selected.length>=MAX)break;if(item.label!=='Whole tree'&&!usedS.has(item.url)){selected.push(item);usedS.add(item.url);}}
    for (const item of pool){if(selected.length>=MAX)break;if(!usedS.has(item.url)){selected.push(item);usedS.add(item.url);}}
    const htIdx=selected.findIndex(s=>s.label==='Whole tree');
    if(htIdx>0){const[ht]=selected.splice(htIdx,1);selected.unshift(ht);}
    imgC[la]=selected; return selected;
  } catch(e) {
    try { const t=la.replace(/ /g,'_');const r=await fetch('https://en.wikipedia.org/w/api.php?action=query&titles='+encodeURIComponent(t)+'&prop=pageimages&format=json&pithumbsize=800&origin=*');const d=await r.json();const p=Object.values(d.query.pages)[0];if(p&&p.thumbnail&&p.thumbnail.source){const res=[{url:p.thumbnail.source,label:''}];imgC[la]=res;return res;}} catch(e2){}
    imgC[la]=[]; return [];
  }
}
function loadCardImg(el, la) {
  fetchImgs(la).then(imgs => {
    if (!imgs.length) { el.innerHTML='<div class="ph">'+la+'</div>'; return; }
    const img=new Image();img.alt=la;
    img.onload=()=>{el.querySelector('.skel')?.remove();img.classList.add('ld');el.appendChild(img);};
    img.onerror=()=>{el.querySelector('.skel')?.remove();el.innerHTML='<div class="ph">'+la+'</div>';};
    img.src=imgs[0].url;
  });
}

// ================================================================
// NAVIGATION & HISTORY API
// ================================================================
function go(v, pushState=true) {
  view = v;
  document.querySelectorAll('.v').forEach(e=>e.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('on'));
  document.getElementById('v-'+v).classList.add('on');
  document.querySelector('.tab[data-v="'+v+'"]')?.classList.add('on');
  document.getElementById('tabs').style.display='flex';
  document.getElementById('det').classList.remove('on');
  if(v==='fieldlog') renderML();
  if(v==='browse') renderGrid();
  window.scrollTo(0,0);
  if(pushState) history.pushState({view:v},'','#'+v);
}
window.addEventListener('popstate', e => {
  const state = e.state;
  if (!state) { go('browse',false); return; }
  if (state.detail) { openDet(state.detail, false); return; }
  if (state.view) {
    document.getElementById('det').classList.remove('on');
    document.getElementById('tabs').style.display='flex';
    // Close any modals
    closeSightModal();
    closeMapModal();
    go(state.view, false);
    // Restore key state if identify
    if(state.view==='identify'&&state.keyH) { keyH=state.keyH; renderK(keyH[keyH.length-1]); }
    return;
  }
  go('browse',false);
});

// ================================================================
// BROWSE
// ================================================================
function renderPills() {
  document.getElementById('pills').innerHTML =
    '<button class="pill on" onclick="setF(\'all\',this)">All</button>' +
    GRP.map(g=>'<button class="pill" onclick="setF(\''+g.id+'\',this)">'+g.name+'</button>').join('');
}
function setF(f,btn) { filter=f;document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));btn.classList.add('on');renderGrid(); }
function renderGrid() {
  const el=document.getElementById('grid'), list=filter==='all'?SP:SP.filter(s=>s.g===filter), seenIds=getSeenIds();
  el.innerHTML = list.map(s => {
    const ck=seenIds.includes(s.id);
    return '<div class="card" onclick="openDet(\''+s.id+'\')">'+
      (ck?'<div class="card-ck"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>':'')+
      '<div class="card-img" id="ci-'+s.id+'"><div class="skel"></div></div>'+
      '<div class="card-txt"><div class="card-nm">'+s.en+'</div><div class="card-la">'+s.la+'</div></div></div>';
  }).join('');
  list.forEach(s=>{const e=document.getElementById('ci-'+s.id);if(e) loadCardImg(e,s.la);});
}

// ================================================================
// DETAIL
// ================================================================
function openDet(id, pushState=true) {
  const s=SP.find(x=>x.id===id);if(!s)return;
  const g=GRP.find(x=>x.id===s.g), sl=getSightingsFor(s.id), count=sl.length;
  let h = '<div class="car"><div class="car-t" id="ct-'+s.id+'" onscroll="onCS(\''+s.id+'\')"><div class="car-s"><div class="skel"></div></div></div><div class="car-d" id="cd-'+s.id+'"></div></div>'+
    '<div class="det-b"><div class="det-g" style="color:'+g.fg+';background:'+g.bg+'">'+g.name+'</div>'+
    '<h1 class="det-en">'+s.en+'</h1><p class="det-la">'+s.la+'</p>'+
    (s.da?'<p class="det-da">Danish: '+s.da+'</p>':'')+
    '<div class="spot-area">'+
      '<button class="spot-btn spot-primary" onclick="openSightModal(\''+s.id+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="2"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>'+(count?'Log Another Sighting':'Log Sighting')+'</button>'+
      (count?'<div class="spot-count"><strong>'+count+'</strong> sighting'+(count>1?'s':'')+' recorded</div>':'')+
    '</div>'+
    '<div class="det-m"><div class="meta"><div class="meta-l">Height</div><div class="meta-v">'+s.ht+'</div></div><div class="meta"><div class="meta-l">Lifespan</div><div class="meta-v">'+s.life+'</div></div></div>';

  // Show sightings if any
  if(count) {
    h += '<div class="sect"><h3 class="sect-t">Sightings</h3><div class="sight-list">';
    sl.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach((sg,i) => {
      const d=new Date(sg.date);
      const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      const timeStr=d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      const locStr=sg.lat?sg.lat.toFixed(4)+'°N, '+sg.lng.toFixed(4)+'°E':'No location';
      h += '<div class="sight-item">'+
        '<div class="sight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="1.8"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg></div>'+
        '<div class="sight-info"><div class="sight-date">'+dateStr+' at '+timeStr+'</div><div class="sight-loc">'+locStr+'</div>'+
        (sg.note?'<div class="sight-note">'+sg.note+'</div>':'')+
        '</div>'+
        '<button class="sight-del" onclick="event.stopPropagation();delSighting(\''+s.id+'\','+i+')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/></svg></button>'+
        '</div>';
    });
    h += '</div></div>';
  }

  h += '<div class="sect"><h3 class="sect-t">Habitat</h3><p>'+s.hab+'</p></div>'+
    '<div class="sect"><h3 class="sect-t">Key Identifying Features</h3><ul>'+s.feat.map(f=>'<li>'+f+'</li>').join('')+'</ul></div>'+
    '<div class="sect"><h3 class="sect-t">Seasonal Notes</h3><p>'+s.season+'</p></div>'+
    (s.conf&&s.conf.length?'<div class="sect"><h3 class="sect-t">Could Be Confused With</h3>'+s.conf.map(c=>'<div class="conf"><div class="conf-n">'+c.sp+'</div><div class="conf-d">'+c.d+'</div></div>').join('')+'</div>':'')+
    '</div>';

  document.getElementById('di').innerHTML = h;

  fetchImgs(s.la).then(imgs => {
    const tr=document.getElementById('ct-'+s.id),dots=document.getElementById('cd-'+s.id);
    if(!imgs.length){tr.innerHTML='<div class="car-s"><div class="ph">'+s.la+'</div></div>';return;}
    tr.innerHTML=imgs.map((im,i)=>'<div class="car-s"><div class="skel"></div>'+(im.label?'<div class="car-lbl">'+im.label+'</div>':'')+'<div class="car-ct">'+(i+1)+' / '+imgs.length+'</div></div>').join('');
    const slides=tr.querySelectorAll('.car-s');
    imgs.forEach((im,i)=>{const img=new Image();img.alt=s.en+' — '+(im.label||'');img.onload=()=>{slides[i].querySelector('.skel')?.remove();slides[i].insertBefore(img,slides[i].firstChild);};img.onerror=()=>{slides[i].querySelector('.skel')?.remove();};img.src=im.url;});
    if(imgs.length>1) dots.innerHTML=imgs.map((_,i)=>'<div class="car-dot'+(i===0?' on':'')+'"></div>').join('');
  });

  document.getElementById('det').classList.add('on');
  document.getElementById('det').scrollTop=0;
  document.getElementById('tabs').style.display='none';
  if(pushState) history.pushState({detail:id},'','#detail/'+id);
}
function onCS(id) {
  const tr=document.getElementById('ct-'+id);if(!tr)return;
  const idx=Math.round(tr.scrollLeft/tr.offsetWidth);
  document.querySelectorAll('#cd-'+id+' .car-dot').forEach((d,i)=>d.classList.toggle('on',i===idx));
}
function closeDet() {
  document.getElementById('det').classList.remove('on');
  document.getElementById('tabs').style.display='flex';
  if(view==='browse') renderGrid();
  if(view==='fieldlog') renderML();
  history.back();
}

// ================================================================
// SIGHTINGS
// ================================================================
function openSightModal(id) {
  sightModalSpecies = id;
  const modal = document.getElementById('sight-modal');
  modal.classList.add('on');
  // Set current date/time
  const now = new Date();
  const dt = document.getElementById('sight-dt');
  dt.value = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'T'+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  document.getElementById('sight-note').value = '';
  history.pushState({view:view,modal:'sight'},'','#sighting');
  // Init map after modal is visible
  setTimeout(()=>{
    if(sightMap){sightMap.remove();sightMap=null;}
    const mapEl = document.getElementById('sight-map');
    sightMap = L.map(mapEl,{zoomControl:false}).setView([55.676,12.568],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap',maxZoom:19}).addTo(sightMap);
    L.control.zoom({position:'topright'}).addTo(sightMap);
    sightMarker = L.marker([55.676,12.568],{draggable:true}).addTo(sightMap);
    // Try GPS
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos=>{
        const ll=[pos.coords.latitude,pos.coords.longitude];
        sightMap.setView(ll,15);
        sightMarker.setLatLng(ll);
      },()=>{},{enableHighAccuracy:true,timeout:8000});
    }
    sightMap.invalidateSize();
  },350);
}
function closeSightModal() {
  document.getElementById('sight-modal').classList.remove('on');
  if(sightMap){sightMap.remove();sightMap=null;}
  sightModalSpecies = null;
}
function saveSighting() {
  if(!sightModalSpecies) return;
  const dt = document.getElementById('sight-dt').value;
  const note = document.getElementById('sight-note').value.trim();
  const ll = sightMarker ? sightMarker.getLatLng() : null;
  sightings.push({
    id: sightModalSpecies,
    date: dt ? new Date(dt).toISOString() : new Date().toISOString(),
    lat: ll ? ll.lat : null,
    lng: ll ? ll.lng : null,
    note: note
  });
  localStorage.setItem('fs-sightings', JSON.stringify(sightings));
  closeSightModal();
  updB();
  // Re-open detail to show updated sightings
  openDet(sightModalSpecies || sightings[sightings.length-1].id, false);
}
function delSighting(speciesId, sortedIdx) {
  // Get sightings for species sorted by date desc (same order as display)
  const sl = getSightingsFor(speciesId).sort((a,b)=>new Date(b.date)-new Date(a.date));
  const target = sl[sortedIdx];
  if(!target) return;
  // Find and remove from main array
  const mainIdx = sightings.indexOf(target);
  if(mainIdx>-1) sightings.splice(mainIdx,1);
  localStorage.setItem('fs-sightings',JSON.stringify(sightings));
  updB();
  openDet(speciesId, false);
}
function updB() {
  const b=document.getElementById('badge'),n=getSeenIds().length;
  if(n>0){b.textContent=n;b.style.display='flex';}else b.style.display='none';
}

// ================================================================
// FIELD LOG
// ================================================================
function renderML() {
  const el=document.getElementById('mlc'),seenIds=getSeenIds(),n=seenIds.length,pct=(n/SP.length*100).toFixed(0);
  let h = '<div style="padding:8px 20px 0"><div class="mc">'+n+'<small> / '+SP.length+' species spotted</small></div></div><div class="pw"><div class="pf" style="width:'+pct+'%"></div></div><p class="mhn">'+(n===0?'Log your first sighting to start tracking.':n===SP.length?"You've spotted them all!":(SP.length-n)+' more to find.')+'</p>';
  if(sightings.length && sightings.some(s=>s.lat)) {
    h += '<button class="map-all-btn" onclick="openMapModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="1.8"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>View All on Map</button>';
  }
  if(!n) {
    h += '<div class="me"><p>Head outside and log your first tree sighting!</p></div>';
  } else {
    // Group by species, sort by most recent sighting
    const speciesOrder = seenIds.map(id=>{
      const sl=getSightingsFor(id);
      const latest=sl.sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
      return {id,count:sl.length,latest};
    }).sort((a,b)=>new Date(b.latest.date)-new Date(a.latest.date));
    speciesOrder.forEach(({id,count,latest})=>{
      const s=SP.find(x=>x.id===id);if(!s)return;
      const d=new Date(latest.date);
      const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
      h += '<div class="mr" onclick="openDet(\''+s.id+'\')">'+
        '<div class="mth" id="mt-'+s.id+'"><div class="skel" style="width:100%;height:100%"></div></div>'+
        '<div class="mi"><div class="mn">'+s.en+'</div><div class="mla">'+s.la+'</div>'+
        '<div class="msub">'+count+' sighting'+(count>1?'s':'')+' · Last: '+dateStr+'</div></div>'+
        '<button class="mrm" onclick="event.stopPropagation();rmSpecies(\''+s.id+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/></svg></button></div>';
    });
  }
  el.innerHTML = h;
  seenIds.forEach(id=>{const s=SP.find(x=>x.id===id);if(!s)return;const e=document.getElementById('mt-'+s.id);if(e)loadCardImg(e,s.la);});
}
function rmSpecies(id) {
  sightings = sightings.filter(s=>s.id!==id);
  localStorage.setItem('fs-sightings',JSON.stringify(sightings));
  updB(); renderML();
}

// ================================================================
// FULL MAP MODAL
// ================================================================
function openMapModal() {
  document.getElementById('map-modal').classList.add('on');
  document.getElementById('tabs').style.display='none';
  history.pushState({view:view,modal:'map'},'','#map');
  setTimeout(()=>{
    if(fullMap){fullMap.remove();fullMap=null;}
    fullMap=L.map('full-map',{zoomControl:false}).setView([55.676,12.568],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap',maxZoom:19}).addTo(fullMap);
    L.control.zoom({position:'topright'}).addTo(fullMap);
    const bounds=[];
    sightings.forEach(sg=>{
      if(!sg.lat) return;
      const s=SP.find(x=>x.id===sg.id);
      const d=new Date(sg.date);
      const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      const m=L.marker([sg.lat,sg.lng]).addTo(fullMap);
      m.bindPopup('<strong>'+(s?s.en:sg.id)+'</strong><br>'+dateStr+(sg.note?'<br><em>'+sg.note+'</em>':''));
      bounds.push([sg.lat,sg.lng]);
    });
    if(bounds.length) fullMap.fitBounds(bounds,{padding:[50,50],maxZoom:14});
    fullMap.invalidateSize();
  },300);
}
function closeMapModal() {
  document.getElementById('map-modal').classList.remove('on');
  document.getElementById('tabs').style.display='flex';
  if(fullMap){fullMap.remove();fullMap=null;}
}

// ================================================================
// IDENTIFY — Visual Decision Tree
// ================================================================
function startKey() {
  keyH = [{step:'start',answer:null}];
  renderTree();
  history.pushState({view:'identify',keyH:keyH.map(k=>k.step)},'','#identify/start');
}

function renderTree() {
  const el = document.getElementById('idc');
  const current = keyH[keyH.length-1];
  const k = KEY[current.step];
  if (!k) return;

  let html = '<div class="tree-wrap">';
  html += '<button class="tree-restart" onclick="go(\'identify\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="14" height="14" stroke-width="2"><path d="M1 4v6h6" stroke-linecap="round" stroke-linejoin="round"/><path d="M3.51 15a9 9 0 105.64-9.14L1 10" stroke-linecap="round" stroke-linejoin="round"/></svg>Start Over</button>';

  // Render answered steps
  for (let i = 0; i < keyH.length - 1; i++) {
    const step = keyH[i];
    const kk = KEY[step.step];
    if (!kk) continue;
    html += '<div class="tree-step">';
    html += '<div class="tree-dot"></div>';
    html += '<div class="tree-step-q">' + kk.q + '</div>';
    html += '<div class="tree-step-a">' + step.answer + '</div>';
    html += '</div>';
  }

  // Render current question with branch options
  html += '<div class="tree-current">';
  html += '<div class="tree-dot"></div>';
  html += '<div class="tree-q">' + k.q + '</div>';

  const optCount = k.o.length;
  html += '<div class="tree-options' + (optCount === 2 ? ' binary' : '') + '">';
  k.o.forEach(o => {
    if (o.r) {
      html += '<button class="tree-opt" onclick="keyResult(\'' + o.r + '\',\'' + esc(o.t) + '\')">' + o.t + '</button>';
    } else {
      html += '<button class="tree-opt" onclick="keyAnswer(\'' + o.n + '\',\'' + esc(o.t) + '\')">' + o.t + '</button>';
    }
  });
  html += '</div></div></div>';

  el.innerHTML = html;
  // Scroll to current question
  setTimeout(() => {
    const cur = el.querySelector('.tree-current');
    if (cur) cur.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

function esc(s) { return s.replace(/'/g, "\\'").replace(/"/g, '&quot;'); }

function keyAnswer(nextStep, answerText) {
  keyH[keyH.length-1].answer = answerText;
  keyH.push({step: nextStep, answer: null});
  renderTree();
  history.pushState({view:'identify',keyH:keyH.map(k=>k.step)},'','#identify/'+nextStep);
}

function keyResult(speciesId, answerText) {
  keyH[keyH.length-1].answer = answerText;
  const s = SP.find(x => x.id === speciesId);
  if (!s) return;
  const el = document.getElementById('idc');

  let html = '<div class="tree-wrap">';
  html += '<button class="tree-restart" onclick="go(\'identify\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="14" height="14" stroke-width="2"><path d="M1 4v6h6" stroke-linecap="round" stroke-linejoin="round"/><path d="M3.51 15a9 9 0 105.64-9.14L1 10" stroke-linecap="round" stroke-linejoin="round"/></svg>Start Over</button>';

  // All answered steps
  for (let i = 0; i < keyH.length; i++) {
    const step = keyH[i];
    const kk = KEY[step.step];
    if (!kk) continue;
    html += '<div class="tree-step">';
    html += '<div class="tree-dot"></div>';
    html += '<div class="tree-step-q">' + kk.q + '</div>';
    html += '<div class="tree-step-a">' + (step.answer||'') + '</div>';
    html += '</div>';
  }

  // Result
  html += '<div class="tree-result"><div class="tree-dot"></div>';
  html += '<div class="kr"><p class="kr-l">Your tree is likely</p><h2 class="kr-n">' + s.en + '</h2><p class="kr-la">' + s.la + '</p>';
  html += '<div class="kri" id="kri"><div class="skel" style="width:100%;height:100%;border-radius:50%"></div></div>';
  html += '<div class="kr-btns"><button class="bp" onclick="openDet(\'' + s.id + '\')">View Profile</button><button class="bs" onclick="startKey()">Try Again</button></div>';
  html += '</div></div></div>';

  el.innerHTML = html;

  fetchImgs(s.la).then(imgs => {
    const e = document.getElementById('kri');
    if (!imgs.length) { e.innerHTML = '<div class="ph">' + s.la + '</div>'; return; }
    const img = new Image(); img.alt = s.la;
    img.onload = () => { e.querySelector('.skel')?.remove(); e.appendChild(img); };
    img.onerror = () => { e.innerHTML = '<div class="ph">' + s.la + '</div>'; };
    img.src = imgs[0].url;
  });

  // Scroll to result
  setTimeout(() => {
    const res = el.querySelector('.tree-result');
    if (res) res.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

// Back navigation in tree
function renderK(step) {
  // Rebuild keyH to match step
  const idx = keyH.findIndex(k=>k.step===step);
  if(idx>=0) { keyH=keyH.slice(0,idx+1); keyH[keyH.length-1].answer=null; }
  renderTree();
}

// ================================================================
// INIT
// ================================================================
renderPills(); renderGrid(); updB();
// Set initial history state
history.replaceState({view:'browse'},'','#browse');

if ('serviceWorker' in navigator) {
  const sw = "const C='flora-v5';self.addEventListener('install',()=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(caches.open(C).then(c=>caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k))))).then(()=>clients.claim())));self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(caches.match(e.request).then(c=>{const f=fetch(e.request).then(r=>{if(r&&r.status===200){const cl=r.clone();caches.open(C).then(ca=>ca.put(e.request,cl));}return r;}).catch(()=>c);return c||f;}));});";
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], {type: 'application/javascript'}))).catch(() => {});
}
</script>
</body>
</html>
