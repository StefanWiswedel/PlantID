<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1a">
<title>Flora Sjælland</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=DM+Sans:ital,opsz,wght@0,9..40,300..600;1,9..40,300..600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8f7f4;--sf:#fff;--tx:#1a1a1a;--tx2:#6b6b6b;--tx3:#a0a0a0;
  --ac:#2d6a4f;--acl:#e8f5e9;--ac2:#40916c;
  --wm:#c4633f;--wml:#fef0ec;
  --bd:rgba(0,0,0,.06);
  --fs:'Playfair Display',serif;--fb:'DM Sans',sans-serif;
  --sb:env(safe-area-inset-bottom,0px);--st:env(safe-area-inset-top,0px);
  --th:60px;--rad:14px;
}
html{font-size:16px;-webkit-text-size-adjust:100%}
body{font-family:var(--fb);color:var(--tx);background:var(--bg);-webkit-font-smoothing:antialiased;overflow-x:hidden;overscroll-behavior-y:contain}
button{font-family:inherit;border:none;background:none;cursor:pointer;color:inherit;-webkit-tap-highlight-color:transparent}
img{display:block;max-width:100%}
#app{min-height:100dvh;padding-bottom:calc(var(--th) + var(--sb) + 8px)}

/* === TABS === */
.tabs{position:fixed;bottom:0;left:0;right:0;z-index:900;background:rgba(248,247,244,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--bd);padding-bottom:var(--sb);display:flex;height:calc(var(--th) + var(--sb))}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;font-size:.62rem;font-weight:500;letter-spacing:.04em;color:var(--tx3);transition:color .15s;padding-top:6px}
.tab.on{color:var(--ac)}
.tab svg{width:22px;height:22px;stroke-width:1.7}
.tab-ic{position:relative}
.badge{position:absolute;top:-5px;right:-9px;background:var(--wm);color:#fff;font-size:.52rem;font-weight:600;min-width:15px;height:15px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px}

/* === VIEWS === */
.v{display:none;min-height:100dvh}.v.on{display:block;animation:vIn .25s ease}
@keyframes vIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* === BROWSE === */
.bh{padding:calc(var(--st) + 28px) 24px 20px;background:linear-gradient(160deg,#1b4332 0%,#2d6a4f 50%,#40916c 100%);margin-bottom:6px}
.logo{font-family:var(--fs);font-size:2.6rem;letter-spacing:-.02em;line-height:1;font-weight:700;color:#fff}
.logo i{font-style:italic;font-weight:400;color:#b7e4c7}
.bsub{color:rgba(255,255,255,.6);font-size:.82rem;margin-top:8px;font-weight:300}
.bh-link{display:inline-flex;align-items:center;gap:5px;margin-top:12px;padding:6px 14px;border-radius:100px;background:rgba(255,255,255,.12);color:rgba(255,255,255,.7);font-size:.72rem;font-weight:500;text-decoration:none;backdrop-filter:blur(4px);transition:all .15s}
.bh-link:active{background:rgba(255,255,255,.2)}
/* Search */
.search-wrap{position:relative;padding:14px 20px 0}
.search-input{width:100%;padding:11px 14px 11px 38px;border:1.5px solid var(--bd);border-radius:100px;font-family:inherit;font-size:.86rem;background:var(--sf);color:var(--tx);transition:border-color .15s;outline:none}
.search-input:focus{border-color:var(--ac)}
.search-input::placeholder{color:var(--tx3)}
.search-icon{position:absolute;left:34px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--tx3);pointer-events:none}
.search-clear{position:absolute;right:28px;top:50%;transform:translateY(-50%);width:24px;height:24px;display:none;align-items:center;justify-content:center;color:var(--tx3);border-radius:50%}
.search-clear:active{background:rgba(0,0,0,.06)}
.search-results{position:absolute;left:20px;right:20px;top:100%;z-index:100;background:var(--sf);border-radius:var(--rad);box-shadow:0 4px 20px rgba(0,0,0,.12);max-height:320px;overflow-y:auto;display:none}
.search-results.on{display:block}
.search-item{display:flex;align-items:center;gap:12px;padding:10px 14px;cursor:pointer;transition:background .1s}
.search-item:active,.search-item:hover{background:rgba(0,0,0,.03)}
.search-item-name{font-size:.86rem;font-weight:500}
.search-item-la{font-size:.74rem;color:var(--tx2);font-style:italic;font-weight:300}
.search-item-grp{font-size:.62rem;color:var(--tx3);margin-left:auto;flex-shrink:0}

.pills{display:flex;gap:8px;padding:14px 20px 14px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.pills::-webkit-scrollbar{display:none}
.pill{flex-shrink:0;padding:8px 16px;border-radius:100px;font-size:.78rem;font-weight:500;background:transparent;color:var(--tx2);border:1.5px solid rgba(0,0,0,.08);transition:all .15s;white-space:nowrap}
.pill.on{background:var(--ac);color:#fff;border-color:var(--ac)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 10px 24px}
.card{position:relative;overflow:hidden;cursor:pointer;background:var(--sf);border-radius:var(--rad);-webkit-tap-highlight-color:transparent;box-shadow:0 1px 4px rgba(0,0,0,.05);transition:transform .15s}
.card:active{transform:scale(.97)}
.card-img{aspect-ratio:3/4;background:#e8e6e1;position:relative;overflow:hidden;border-radius:var(--rad) var(--rad) 0 0}
.card-img img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .35s}
.card-img img.ld{opacity:1}
.skel{position:absolute;inset:0;background:linear-gradient(110deg,#e8e6e1 30%,#f0eee9 50%,#e8e6e1 70%);background-size:200% 100%;animation:shim 1.4s infinite}
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
.card-txt{padding:10px 12px 12px}
.card-nm{font-size:.84rem;font-weight:500;line-height:1.2}
.card-la{font-size:.72rem;color:var(--tx2);font-style:italic;margin-top:2px;font-weight:300}
.card-ck{position:absolute;top:8px;right:8px;width:26px;height:26px;border-radius:50%;background:var(--wm);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.18)}
.card-ck svg{width:13px;height:13px;color:#fff;stroke-width:2.5}

/* === DETAIL === */
.det{position:fixed;inset:0;z-index:950;background:var(--bg);overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}
.det.on{display:block;animation:dIn .3s ease}
@keyframes dIn{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}
.det-x{position:fixed;top:calc(var(--st) + 12px);left:14px;z-index:960;width:38px;height:38px;border-radius:50%;background:rgba(0,0,0,.35);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;transition:transform .15s}
.det-x:active{transform:scale(.88)}
.det-x svg{width:20px;height:20px;color:#fff;stroke-width:2}
.car{position:relative;width:100%;overflow:hidden}
.car-t{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.car-t::-webkit-scrollbar{display:none}
.car-s{flex:0 0 100%;scroll-snap-align:start;aspect-ratio:3/4;background:#e0ddd6;position:relative}
.car-s img{width:100%;height:100%;object-fit:cover}
.car-d{display:flex;gap:5px;justify-content:center;padding:12px 0 4px}
.car-dot{width:7px;height:7px;border-radius:50%;background:var(--tx3);opacity:.25;transition:all .2s}
.car-dot.on{opacity:1;background:var(--ac);transform:scale(1.3)}
.car-lbl{position:absolute;bottom:14px;left:14px;background:rgba(0,0,0,.5);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);color:#fff;font-size:.66rem;font-weight:500;padding:4px 10px;border-radius:100px;text-transform:capitalize;letter-spacing:.02em}
.car-ct{position:absolute;bottom:14px;right:14px;background:rgba(0,0,0,.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);color:#fff;font-size:.66rem;font-weight:500;padding:4px 10px;border-radius:100px}
.det-b{padding:22px 20px 48px}
.det-g{display:inline-block;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;padding:5px 12px;border-radius:100px;margin-bottom:12px}
.det-en{font-family:var(--fs);font-size:1.9rem;line-height:1.15;letter-spacing:-.01em;font-weight:700}
.det-la{font-size:.95rem;font-style:italic;color:var(--tx2);margin-top:3px;font-weight:300}
.det-da{font-size:.82rem;color:var(--tx2);margin-top:5px}

/* Sighting button */
.spot-area{margin-top:18px;display:flex;flex-direction:column;gap:10px}
.spot-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border-radius:var(--rad);font-size:.85rem;font-weight:500;transition:all .2s}
.spot-primary{background:var(--ac);color:#fff}
.spot-primary:active{background:var(--ac2);transform:scale(.98)}
.spot-count{font-size:.8rem;color:var(--tx2);text-align:center}
.spot-count strong{color:var(--wm);font-weight:600}

/* Sightings timeline in detail */
.sight-list{margin-top:12px}
.sight-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--bd)}
.sight-item:last-child{border-bottom:none}
.sight-icon{width:36px;height:36px;border-radius:10px;background:var(--acl);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--ac)}
.sight-info{flex:1;min-width:0}
.sight-date{font-size:.82rem;font-weight:500}
.sight-loc{font-size:.74rem;color:var(--tx2);margin-top:2px}
.sight-note{font-size:.76rem;color:var(--tx2);margin-top:3px;font-style:italic}
.sight-del{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--tx3);flex-shrink:0}
.sight-del:active{background:var(--wml);color:var(--wm)}

.det-m{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px}
.meta{background:var(--sf);border-radius:var(--rad);padding:13px 14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.meta-l{font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);font-weight:500}
.meta-v{font-size:.86rem;margin-top:3px;font-weight:500}
.sect{margin-top:28px}
.sect-t{font-size:.64rem;text-transform:uppercase;letter-spacing:.1em;color:var(--tx2);font-weight:600;margin-bottom:10px}
.sect p,.sect li{font-size:.88rem;line-height:1.65;color:#3a3a3a}
.sect ul{list-style:none}
.sect li{padding:5px 0 5px 16px;position:relative}
.sect li::before{content:'';position:absolute;left:0;top:13px;width:5px;height:5px;border-radius:50%;background:var(--ac);opacity:.35}
.conf{background:var(--sf);border-radius:var(--rad);padding:14px 16px;margin-top:8px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.conf-n{font-weight:500;font-size:.85rem}
.conf-d{font-size:.82rem;color:var(--tx2);margin-top:4px;line-height:1.55}

/* === IDENTIFY VIEW === */
.ih{padding:calc(var(--st) + 28px) 24px 20px;background:linear-gradient(160deg,#1b4332,#2d6a4f)}
.it{font-family:var(--fs);font-size:1.9rem;color:#fff;font-weight:700}
.it-sub{color:rgba(255,255,255,.55);font-size:.82rem;margin-top:6px;font-weight:300}

/* === SMART FILTER === */
.sf-wrap{padding:12px 16px 24px}
.sf-intro{text-align:center;color:var(--tx2);font-size:.84rem;padding:8px 0 16px;line-height:1.5}
.sf-match-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;margin:0 16px 8px;background:var(--sf);border-radius:var(--rad);box-shadow:0 1px 3px rgba(0,0,0,.04)}
.sf-match-count{font-size:.88rem;font-weight:600}
.sf-match-count strong{color:var(--ac)}
.sf-match-reset{font-size:.78rem;color:var(--wm);font-weight:500;padding:4px 10px;border-radius:6px}
.sf-match-reset:active{background:var(--wml)}
.sf-cat{background:var(--sf);border-radius:var(--rad);margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.04);overflow:hidden}
.sf-cat-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.sf-cat-head:active{background:rgba(0,0,0,.02)}
.sf-cat-label{font-size:.88rem;font-weight:600}
.sf-cat-sel{font-size:.74rem;color:var(--ac);font-weight:500}
.sf-cat-clear{font-size:.72rem;color:var(--wm);font-weight:500;padding:4px 8px;border-radius:6px}
.sf-cat-clear:active{background:var(--wml)}
.sf-cat-body{padding:0 12px 12px;display:none}
.sf-cat.open .sf-cat-body{display:block}
.sf-cat-chevron{width:18px;height:18px;color:var(--tx3);transition:transform .2s;flex-shrink:0}
.sf-cat.open .sf-cat-chevron{transform:rotate(180deg)}
.sf-opts{display:flex;flex-wrap:wrap;gap:8px}
.sf-opt{padding:9px 14px;border:1.5px solid var(--bd);border-radius:100px;font-size:.8rem;color:var(--tx);background:var(--bg);transition:all .15s;-webkit-tap-highlight-color:transparent}
.sf-opt:active{transform:scale(.96)}
.sf-opt.on{background:var(--ac);color:#fff;border-color:var(--ac)}
.sf-opt.dim{opacity:.35;pointer-events:none}
.sf-opt .ct{font-size:.68rem;color:var(--tx3);margin-left:3px}
.sf-opt.on .ct{color:rgba(255,255,255,.7)}
.sf-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:16px 16px 24px}

/* Loading state */
.loading{display:flex;align-items:center;justify-content:center;min-height:50vh;flex-direction:column;gap:12px}
.loading p{color:var(--tx2);font-size:.88rem}
.spinner{width:32px;height:32px;border:3px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* === FIELD LOG === */
.mh{padding:calc(var(--st) + 28px) 24px 20px;background:linear-gradient(160deg,#1b4332,#2d6a4f)}
.mc{font-family:var(--fs);font-size:2.8rem;color:var(--ac);line-height:1;font-weight:700}
.mc small{font-size:.88rem;color:var(--tx2);font-weight:300;font-family:var(--fb)}
.pw{margin:14px 20px 4px;height:5px;background:rgba(0,0,0,.05);border-radius:3px;overflow:hidden}
.pf{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:3px;transition:width .4s ease}
.mhn{font-size:.78rem;color:var(--tx2);padding:0 20px;margin-bottom:8px;font-weight:300}
.log-tabs{display:flex;gap:0;padding:8px 20px 12px}
.log-tab{flex:1;padding:10px;text-align:center;font-size:.8rem;font-weight:500;color:var(--tx2);border-bottom:2px solid transparent;transition:all .15s}
.log-tab.on{color:var(--ac);border-bottom-color:var(--ac)}
.me{text-align:center;padding:48px 24px}
.me p{color:var(--tx2);font-size:.88rem;margin-top:8px;line-height:1.5}
.mr{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:background .1s}
.mr:active{background:rgba(0,0,0,.03)}
.mth{width:48px;height:48px;border-radius:12px;background:#e0ddd6;overflow:hidden;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.mth img{width:100%;height:100%;object-fit:cover}
.mi{flex:1;min-width:0}
.mn{font-size:.86rem;font-weight:500}
.mla{font-size:.74rem;color:var(--tx2);font-style:italic;font-weight:300}
.msub{font-size:.72rem;color:var(--tx3);margin-top:2px}
.mrm{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--tx3);flex-shrink:0}
.mrm:active{background:var(--wml);color:var(--wm)}
.ph{display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:.72rem;color:var(--tx3);font-style:italic;text-align:center;padding:8px}

/* Map button in field log */
.map-all-btn{display:flex;align-items:center;justify-content:center;gap:8px;margin:8px 20px 16px;padding:12px;border-radius:var(--rad);border:1.5px solid var(--bd);font-size:.84rem;font-weight:500;color:var(--ac);transition:all .15s}
.map-all-btn:active{background:var(--acl);transform:scale(.98)}

/* === SIGHTING MODAL === */
.modal-overlay{position:fixed;inset:0;z-index:970;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center}
.modal-overlay.on{display:flex;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-sheet{width:100%;max-width:500px;max-height:92vh;background:var(--bg);border-radius:20px 20px 0 0;overflow-y:auto;-webkit-overflow-scrolling:touch;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;border-radius:2px;background:rgba(0,0,0,.12);margin:10px auto 0}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px}
.modal-title{font-family:var(--fs);font-size:1.2rem}
.modal-close{width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center}
.modal-close svg{width:16px;height:16px;stroke-width:2.5}
.modal-body{padding:0 20px 32px}
#sight-map{width:100%;height:220px;border-radius:var(--rad);overflow:hidden;margin-bottom:16px;z-index:0}
.form-row{margin-bottom:14px}
.form-label{font-size:.72rem;text-transform:uppercase;letter-spacing:.06em;color:var(--tx2);font-weight:500;margin-bottom:6px;display:block}
.form-input{width:100%;padding:11px 14px;border:1.5px solid var(--bd);border-radius:10px;font-family:inherit;font-size:.86rem;background:var(--sf);color:var(--tx);transition:border-color .15s}
.form-input:focus{outline:none;border-color:var(--ac)}
.form-save{width:100%;padding:14px;border-radius:var(--rad);background:var(--ac);color:#fff;font-size:.88rem;font-weight:500;margin-top:8px;transition:transform .15s}
.form-save:active{transform:scale(.98);background:var(--ac2)}

/* Full map modal */
.map-modal{position:fixed;inset:0;z-index:960;background:var(--bg);display:none}
.map-modal.on{display:block;animation:vIn .25s ease}
.map-modal-head{position:absolute;top:0;left:0;right:0;z-index:1000;display:flex;align-items:center;gap:12px;padding:calc(var(--st) + 12px) 16px 12px;background:rgba(248,247,244,.92);backdrop-filter:blur(16px)}
.map-modal-head h2{font-family:var(--fs);font-size:1.2rem;flex:1}
#full-map{width:100%;height:100%}

/* Leaflet popup overrides */
.leaflet-popup-content-wrapper{border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.12)}
.leaflet-popup-content{font-family:var(--fb);font-size:.82rem;margin:10px 14px}
.leaflet-popup-content strong{font-weight:600}

/* === LIGHTBOX === */
.lb{position:fixed;inset:0;z-index:990;background:rgba(0,0,0,.96);display:none;flex-direction:column;touch-action:none;user-select:none;-webkit-user-select:none}
.lb.on{display:flex}
.lb-top{position:absolute;top:0;left:0;right:0;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:calc(var(--st) + 10px) 14px 10px;background:linear-gradient(to bottom,rgba(0,0,0,.5),transparent)}
.lb-close{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center}
.lb-close:active{background:rgba(255,255,255,.25)}
.lb-close svg{width:20px;height:20px;color:#fff;stroke-width:2}
.lb-info{color:rgba(255,255,255,.7);font-size:.78rem;font-weight:500;text-align:right}
.lb-info div{margin-top:2px;font-size:.68rem;text-transform:capitalize;color:rgba(255,255,255,.45)}
.lb-body{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.lb-img{max-width:100%;max-height:100%;object-fit:contain;transform-origin:center center;transition:transform .1s ease-out;will-change:transform;pointer-events:none}
</style>
</head>
<body>
<div id="app">
  <div class="v on" id="v-browse">
    <div class="bh"><div class="logo">Flora <i>Sjælland</i></div><p class="bsub" id="bsub">Common plants of Zealand</p><a class="bh-link" href="curator.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="13" height="13" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>Curate Images</a></div>
    <div class="search-wrap">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35" stroke-linecap="round"/></svg>
      <input type="text" class="search-input" id="search-input" placeholder="Search by name..." autocomplete="off">
      <button class="search-clear" id="search-clear" onclick="clearSearch()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/></svg></button>
      <div class="search-results" id="search-results"></div>
    </div>
    <div class="pills" id="pills"></div>
    <div class="grid" id="grid"><div class="loading"><div class="spinner"></div><p>Loading species...</p></div></div>
  </div>
  <div class="v" id="v-identify">
    <div class="ih"><h1 class="it">Identify</h1><p class="it-sub">Select features you can see to narrow down species</p></div>
    <div id="sf-match"></div>
    <div id="sf-content"></div>
    <div class="sf-grid" id="sf-grid"></div>
  </div>
  <div class="v" id="v-fieldlog">
    <div class="mh"><div class="logo">Field <i>Log</i></div></div>
    <div id="mlc"></div>
  </div>
</div>
<div class="det" id="det">
  <button class="det-x" onclick="closeDet()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
  <div id="di"></div>
</div>

<!-- Sighting modal -->
<div class="modal-overlay" id="sight-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-head">
      <h3 class="modal-title">Log Sighting</h3>
      <button class="modal-close" onclick="closeSightModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    </div>
    <div class="modal-body">
      <div id="sight-map"></div>
      <div class="form-row"><label class="form-label">Date & Time</label><input type="datetime-local" class="form-input" id="sight-dt"></div>
      <div class="form-row"><label class="form-label">Notes (optional)</label><input type="text" class="form-input" id="sight-note" placeholder="e.g. Large specimen near the lake"></div>
      <button class="form-save" id="sight-save" onclick="saveSighting()">Save Sighting</button>
    </div>
  </div>
</div>

<!-- Full map modal -->
<div class="map-modal" id="map-modal">
  <div class="map-modal-head">
    <button class="det-x" style="position:static;width:36px;height:36px" onclick="closeMapModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    <h2>All Sightings</h2>
  </div>
  <div id="full-map"></div>
</div>

<!-- Lightbox -->
<div class="lb" id="lb">
  <div class="lb-top">
    <button class="lb-close" onclick="closeLb()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
    <div class="lb-info"><span id="lb-counter"></span><div id="lb-label"></div></div>
  </div>
  <div class="lb-body" id="lb-body"><img class="lb-img" id="lb-img" alt=""></div>
</div>

<nav class="tabs" id="tabs">
  <button class="tab on" data-v="browse" onclick="go('browse')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Browse</button>
  <button class="tab" data-v="identify" onclick="go('identify')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v6m0 0l-3-3m3 3l3-3" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6" cy="15" r="3"/><circle cx="18" cy="15" r="3"/><path d="M12 9v3m0 0l-3.5 1.5M12 12l3.5 1.5" stroke-linecap="round"/></svg>Identify</button>
  <button class="tab" data-v="fieldlog" onclick="go('fieldlog')"><span class="tab-ic"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg><span class="badge" id="badge" style="display:none">0</span></span>Field Log</button>
</nav>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================================================================
// DATA (loaded from species.json)
// ================================================================
let SP = [], GRP = [];

// ================================================================
// FILTER DEFINITIONS
// ================================================================
const FILTERS = [
  {id:'form',label:'Growth Form',multi:false,options:[
    {v:'tree',t:'Tree'},{v:'small-tree',t:'Small tree'},{v:'shrub',t:'Shrub'},
    {v:'herb',t:'Herb'},{v:'grass',t:'Grass'},{v:'fern',t:'Fern'},{v:'bulb',t:'Bulb'}]},
  {id:'habitat',label:'Habitat',multi:true,options:[
    {v:'woodland',t:'Woodland'},{v:'hedgerow',t:'Hedgerow'},{v:'meadow',t:'Meadow'},
    {v:'roadside',t:'Roadside'},{v:'park',t:'Park'},{v:'wetland',t:'Wetland'},
    {v:'heath',t:'Heathland'},{v:'coast',t:'Coast'}]},
  {id:'leaf',label:'Leaf Type',multi:false,options:[
    {v:'simple',t:'Simple'},{v:'simple-lobed',t:'Simple, lobed'},
    {v:'compound-pinnate',t:'Compound pinnate'},{v:'compound-palmate',t:'Compound palmate'},
    {v:'compound-trifoliate',t:'Trifoliate'},{v:'compound-ternate',t:'Ternate'},
    {v:'needle',t:'Needle'},{v:'scale-like',t:'Scale-like'},{v:'frond',t:'Frond'}]},
  {id:'leaf_arr',label:'Leaf Arrangement',multi:false,options:[
    {v:'alternate',t:'Alternate'},{v:'opposite',t:'Opposite'},{v:'basal',t:'Basal rosette'},
    {v:'whorled',t:'Whorled'},{v:'spiral',t:'Spiral'},{v:'pairs',t:'In pairs'},
    {v:'clusters',t:'In clusters'},{v:'shuttlecock',t:'Shuttlecock'},{v:'single',t:'Single'}]},
  {id:'flower_color',label:'Flower Colour',multi:false,options:[
    {v:'white',t:'White'},{v:'yellow',t:'Yellow'},{v:'pink',t:'Pink'},{v:'purple',t:'Purple'},
    {v:'blue',t:'Blue'},{v:'green',t:'Green'},{v:'brown',t:'Brown'},{v:'none',t:'None'}]},
  {id:'bloom',label:'Flowering Season',multi:true,options:[
    {v:'spring',t:'Spring'},{v:'summer',t:'Summer'},{v:'autumn',t:'Autumn'},{v:'winter',t:'Winter'}]},
  {id:'notable',label:'Notable Features',multi:true,dynamic:true}
];
// (SP and GRP populated from species.json at runtime)

// ================================================================
// STATE
// ================================================================
let view='browse',filter='all',imgC={};
let sfSel={}, sfOpen={}, notableTags=[];
// Sightings: array of {id, date, lat, lng, note}
let sightings = JSON.parse(localStorage.getItem('fs-sightings')||'[]');
// Migrate old format
const _oldSeen = JSON.parse(localStorage.getItem('fs-seen')||'[]');
if (_oldSeen.length && !sightings.length) {
  sightings = _oldSeen.map(id=>({id,date:new Date().toISOString(),lat:null,lng:null,note:'Migrated from checklist'}));
  localStorage.setItem('fs-sightings',JSON.stringify(sightings));
}
function getSeenIds(){ return [...new Set(sightings.map(s=>s.id))]; }
function getSightingsFor(id){ return sightings.filter(s=>s.id===id); }
let sightModalSpecies = null;
let sightEditIdx = -1; // index into main sightings array; -1 = new
let sightMap = null, sightMarker = null, fullMap = null;

// ================================================================
// CURATED IMAGES
// ================================================================
let curatedImages = null;
async function loadCuratedImages() {
  if (curatedImages !== null) return;
  try { const r = await fetch('images.json'); if (!r.ok) throw 0; curatedImages = await r.json(); }
  catch { curatedImages = {}; }
}
const curatedReady = loadCuratedImages();

// ================================================================
// IMAGE ENGINE
// ================================================================
const FEAT_MAP = [
  { id:'leaf',   label:'Leaves',        kw: /\b(leaf|leaves|leav|foliage|needle|needles)\b/i },
  { id:'bark',   label:'Bark',          kw: /\b(bark|trunk|rind)\b/i },
  { id:'flower', label:'Flowers',       kw: /\b(flower|flowers|blossom|catkin|infloresc|strobil)\b/i },
  { id:'fruit',  label:'Fruit / Seeds', kw: /\b(fruit|fruits|seed|seeds|cone|cones|acorn|nut|berry|berries|haw|samara|strobil)\b/i },
  { id:'bud',    label:'Buds / Twigs',  kw: /\b(bud|buds|twig|shoot)\b/i },
  { id:'autumn', label:'Autumn colour', kw: /\b(autumn|fall|herbst)\b/i },
];
const SKIP_CAT = /cultivar|purpurea|pendula|asplenifolia|tortuosa|fastigiata|dawyck|zlatia|tricolor|laciniata|rotundifolia|atropurpurea|atropunicea|riversii|dissecta|lutescens|columnaris|variegat|illustration|drawing|painting|engrav|watercolour|artwork|sculpture|carving|statue|\bwood\b|timber|lumber|furniture|in\s+(the\s+)?[A-Z]|\bin\s+\w+$|country|region|province|national|state\b|county|district|histor|archiv|\bold\b|centur|vintage|heritage|monument|memorial|people|person|portrait|tourist|visitor|festival|ceremony|event|exhibition|avenue|street|park[^a-z]|garden|urban|city|town|landscape|panorama|fossil|herbarium|microscop|anatomy|phytopatholog|disease|pest|gall|infest|dieback|forest|forestry|logging|plantation|nursery|seedling|hedge|coppic|pollard|root|stump|\bdead\b|fallen|symbol|heraldry|coat.?of.?arms|emblem|\bflag\b|stamp|currency|food|culinar|recipe|honey|syrup|medicine|mythology|folklore|literature|book|animal|bonsai|distribution.?map|famous|incidental|low.?quality|named.?individual|notable|champion.?tree|oldest|largest|record.?tree|remarkable/i;
const SKIP_FILE = /wood[_ ]|timber|lumber|plank|floor|veneer|board|furniture|charcoal|firewood|fossil|herbarium|microscop|cross[_ -]?section|anatomy|pollen[_ ]grain|histolog|painting|drawing|illustration|engraving|lithograph|woodcut|watercolour|sculpture|statue|historical[_ ]|archiv|vintage|antique|postcard|person|people|portrait|tourist|crowd|child|selfie|farmer|worker|museum|stamp|coin|logo|icon|map[_ ]|diagram|\bflag\b|\.svg|chart|screenshot|cultivar|purpurea|pendula|asplenifolia|tortuosa|fastigiata|f\.\s?purpurea|variegat|food|dish|plate|jam|pie|cake|syrup|honey|juice|wine|beer|table[_ ]|kitchen|aerial|panorama|drone|satellite/i;
const COMMONS = 'https://commons.wikimedia.org/w/api.php';

async function fetchSubcats(name) {
  const url = COMMONS+'?action=query&list=categorymembers&cmtitle=Category:'+encodeURIComponent(name)+'&cmtype=subcat&cmlimit=50&format=json&origin=*';
  const r = await fetch(url); if (!r.ok) return [];
  const d = await r.json();
  return (d.query&&d.query.categorymembers||[]).map(c=>c.title);
}
async function fetchCatFiles(catTitle, limit) {
  const url = COMMONS+'?action=query&generator=categorymembers&gcmtitle='+encodeURIComponent(catTitle)+'&gcmtype=file&gcmlimit='+limit+'&prop=imageinfo&iiprop=url&iiurlwidth=800&format=json&origin=*';
  const r = await fetch(url); if (!r.ok) return [];
  const d = await r.json();
  if (!d.query||!d.query.pages) return [];
  return Object.values(d.query.pages).filter(p=>p.imageinfo&&p.imageinfo[0]&&p.imageinfo[0].thumburl).filter(p=>/\.(jpg|jpeg|png)$/i.test(p.title||'')).filter(p=>!SKIP_FILE.test(p.title||'')).map(p=>p.imageinfo[0].thumburl);
}
async function fetchImgs(la) {
  if (imgC[la]) return imgC[la];
  await curatedReady;
  if (curatedImages && curatedImages[la] && curatedImages[la].length > 0) { imgC[la]=curatedImages[la]; return imgC[la]; }
  const name = la.replace(/ /g,'_');
  try {
    const subcats = await fetchSubcats(name);
    const matched = {};
    for (const cat of subcats) { if (SKIP_CAT.test(cat)) continue; for (const feat of FEAT_MAP) { if (feat.kw.test(cat)&&!matched[feat.id]) { matched[feat.id]=cat; break; } } }
    const tasks = [fetchCatFiles('Category:'+name,20)], taskLabels = ['Overview'];
    for (const [fid,catTitle] of Object.entries(matched)) { const feat=FEAT_MAP.find(f=>f.id===fid); tasks.push(fetchCatFiles(catTitle,8)); taskLabels.push(feat?feat.label:fid); }
    const results = await Promise.all(tasks);
    const pool = [], usedUrl = new Set();
    for (let i=1;i<results.length;i++) for (const url of results[i]) if (!usedUrl.has(url)){usedUrl.add(url);pool.push({url,label:taskLabels[i]});}
    for (const url of results[0]) if (!usedUrl.has(url)){usedUrl.add(url);pool.push({url,label:'Overview'});}
    if (!pool.length) throw 0;
    const selected=[],usedLabels=new Set(),MAX=12;
    for (const item of pool){if(selected.length>=MAX)break;if(item.label!=='Overview'&&!usedLabels.has(item.label)){selected.push(item);usedLabels.add(item.label);}}
    const usedS=new Set(selected.map(s=>s.url));
    for (const item of pool){if(selected.length>=MAX)break;if(item.label!=='Overview'&&!usedS.has(item.url)){selected.push(item);usedS.add(item.url);}}
    for (const item of pool){if(selected.length>=MAX)break;if(!usedS.has(item.url)){selected.push(item);usedS.add(item.url);}}
    const htIdx=selected.findIndex(s=>s.label==='Overview');
    if(htIdx>0){const[ht]=selected.splice(htIdx,1);selected.unshift(ht);}
    imgC[la]=selected; return selected;
  } catch(e) {
    try { const t=la.replace(/ /g,'_');const r=await fetch('https://en.wikipedia.org/w/api.php?action=query&titles='+encodeURIComponent(t)+'&prop=pageimages&format=json&pithumbsize=800&origin=*');const d=await r.json();const p=Object.values(d.query.pages)[0];if(p&&p.thumbnail&&p.thumbnail.source){const res=[{url:p.thumbnail.source,label:''}];imgC[la]=res;return res;}} catch(e2){}
    imgC[la]=[]; return [];
  }
}
function loadCardImg(el, la) {
  fetchImgs(la).then(imgs => {
    if (!imgs.length) { el.innerHTML='<div class="ph">'+la+'</div>'; return; }
    const img=new Image();img.alt=la;
    img.onload=()=>{el.querySelector('.skel')?.remove();img.classList.add('ld');el.appendChild(img);};
    img.onerror=()=>{el.querySelector('.skel')?.remove();el.innerHTML='<div class="ph">'+la+'</div>';};
    img.src=imgs[0].url;
  });
}

// ================================================================
// NAVIGATION & HISTORY API
// ================================================================
function go(v, pushState=true) {
  view = v;
  document.querySelectorAll('.v').forEach(e=>e.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('on'));
  document.getElementById('v-'+v).classList.add('on');
  document.querySelector('.tab[data-v="'+v+'"]')?.classList.add('on');
  document.getElementById('tabs').style.display='flex';
  document.getElementById('det').classList.remove('on');
  if(v==='fieldlog') renderML();
  if(v==='browse') renderGrid();
  if(v==='identify') renderSF();
  window.scrollTo(0,0);
  if(pushState) history.pushState({view:v},'','#'+v);
}
window.addEventListener('popstate', e => {
  const state = e.state;
  if (!state) { go('browse',false); return; }
  if (state.detail) { openDet(state.detail, false); return; }
  if (state.view) {
    document.getElementById('det').classList.remove('on');
    document.getElementById('tabs').style.display='flex';
    // Close any modals
    closeSightModal();
    closeMapModal();
    closeLb();
    go(state.view, false);
    return;
  }
  go('browse',false);
});

// ================================================================
// BROWSE
// ================================================================
const imgObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (e.isIntersecting) {
      loadCardImg(e.target, e.target.dataset.la);
      imgObserver.unobserve(e.target);
    }
  });
}, {rootMargin:'200px'});

function renderPills() {
  document.getElementById('pills').innerHTML =
    '<button class="pill on" onclick="setF(\'all\',this)">All</button>' +
    GRP.map(g=>'<button class="pill" onclick="setF(\''+g.id+'\',this)">'+(g.icon?g.icon+' ':'')+g.name+'</button>').join('');
}
function setF(f,btn) { filter=f;document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));btn.classList.add('on');renderGrid(); }
function renderGrid() {
  const el=document.getElementById('grid'), list=filter==='all'?SP:SP.filter(s=>s.g===filter), seenIds=getSeenIds();
  el.innerHTML = list.map(s => {
    const ck=seenIds.includes(s.id);
    return '<div class="card" onclick="openDet(\''+s.id+'\')">'+
      (ck?'<div class="card-ck"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>':'')+
      '<div class="card-img" data-la="'+s.la+'" id="ci-'+s.id+'"><div class="skel"></div></div>'+
      '<div class="card-txt"><div class="card-nm">'+s.en+'</div><div class="card-la">'+s.la+'</div></div></div>';
  }).join('');
  list.forEach(s=>{const e=document.getElementById('ci-'+s.id);if(e) imgObserver.observe(e);});
}
function renderCardGrid(containerId, list) {
  const el=document.getElementById(containerId), seenIds=getSeenIds();
  el.innerHTML = list.map(s => {
    const ck=seenIds.includes(s.id);
    return '<div class="card" onclick="openDet(\''+s.id+'\')">'+
      (ck?'<div class="card-ck"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>':'')+
      '<div class="card-img" data-la="'+s.la+'" id="sfci-'+s.id+'"><div class="skel"></div></div>'+
      '<div class="card-txt"><div class="card-nm">'+s.en+'</div><div class="card-la">'+s.la+'</div></div></div>';
  }).join('');
  list.forEach(s=>{const e=document.getElementById('sfci-'+s.id);if(e) imgObserver.observe(e);});
}

// ================================================================
// SEARCH
// ================================================================
(function(){
  const inp=document.getElementById('search-input');
  const res=document.getElementById('search-results');
  const clr=document.getElementById('search-clear');
  inp.addEventListener('input',()=>{
    const q=inp.value.trim().toLowerCase();
    clr.style.display=q?'flex':'none';
    if(!q||q.length<1){res.classList.remove('on');return;}
    const matches=SP.filter(s=>
      s.en.toLowerCase().includes(q)||
      s.la.toLowerCase().includes(q)||
      (s.da&&s.da.toLowerCase().includes(q))
    ).slice(0,12);
    if(!matches.length){res.innerHTML='<div style="padding:14px 16px;color:var(--tx2);font-size:.84rem">No matches</div>';res.classList.add('on');return;}
    res.innerHTML=matches.map(s=>{
      const g=GRP.find(x=>x.id===s.g);
      return '<div class="search-item" onmousedown="openDet(\''+s.id+'\');clearSearch()">'+
        '<div><div class="search-item-name">'+highlight(s.en,q)+'</div><div class="search-item-la">'+highlight(s.la,q)+(s.da?' · '+highlight(s.da,q):'')+'</div></div>'+
        (g?'<span class="search-item-grp">'+g.name+'</span>':'')+
        '</div>';
    }).join('');
    res.classList.add('on');
  });
  inp.addEventListener('blur',()=>{setTimeout(()=>res.classList.remove('on'),200);});
  inp.addEventListener('focus',()=>{if(inp.value.trim())inp.dispatchEvent(new Event('input'));});
})();
function highlight(text,q){
  const i=text.toLowerCase().indexOf(q);
  if(i<0)return text;
  return text.slice(0,i)+'<mark style="background:var(--acl);color:var(--ac);border-radius:2px;padding:0 1px">'+text.slice(i,i+q.length)+'</mark>'+text.slice(i+q.length);
}
function clearSearch(){
  const inp=document.getElementById('search-input');
  inp.value='';
  document.getElementById('search-clear').style.display='none';
  document.getElementById('search-results').classList.remove('on');
}

// ================================================================
// DETAIL
// ================================================================
function openDet(id, pushState=true) {
  const s=SP.find(x=>x.id===id);if(!s)return;
  const g=GRP.find(x=>x.id===s.g)||{name:'',fg:'#666',bg:'#eee'}, sl=getSightingsFor(s.id), count=sl.length;
  let h = '<div class="car"><div class="car-t" id="ct-'+s.id+'" onscroll="onCS(\''+s.id+'\')"><div class="car-s"><div class="skel"></div></div></div><div class="car-d" id="cd-'+s.id+'"></div></div>'+
    '<div class="det-b"><div class="det-g" style="color:'+g.fg+';background:'+g.bg+'">'+g.name+'</div>'+
    '<h1 class="det-en">'+s.en+'</h1><p class="det-la">'+s.la+'</p>'+
    (s.da?'<p class="det-da">Danish: '+s.da+'</p>':'')+
    '<div class="spot-area">'+
      '<button class="spot-btn spot-primary" onclick="openSightModal(\''+s.id+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="2"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>'+(count?'Log Another Sighting':'Log Sighting')+'</button>'+
      (count?'<div class="spot-count"><strong>'+count+'</strong> sighting'+(count>1?'s':'')+' recorded</div>':'')+
    '</div>'+
    (function(){
      const mi=[];
      if(s.ht)mi.push({l:'Height',v:s.ht});
      if(s.life)mi.push({l:'Lifespan',v:s.life});
      if(!mi.length)return '';
      return '<div class="det-m"'+(mi.length===1?' style="grid-template-columns:1fr"':'')+'>'+mi.map(m=>'<div class="meta"><div class="meta-l">'+m.l+'</div><div class="meta-v">'+m.v+'</div></div>').join('')+'</div>';
    })();

  // Show sightings if any
  if(count) {
    h += '<div class="sect"><h3 class="sect-t">Sightings</h3><div class="sight-list">';
    sl.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach((sg,i) => {
      const d=new Date(sg.date);
      const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      const timeStr=d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      const locStr=sg.lat?sg.lat.toFixed(4)+'°N, '+sg.lng.toFixed(4)+'°E':'No location';
      h += '<div class="sight-item">'+
        '<div class="sight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="1.8"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg></div>'+
        '<div class="sight-info"><div class="sight-date">'+dateStr+' at '+timeStr+'</div><div class="sight-loc">'+locStr+'</div>'+
        (sg.note?'<div class="sight-note">'+sg.note+'</div>':'')+
        '</div>'+
        '<div style="display:flex;gap:4px;flex-shrink:0">'+
        '<button class="sight-del" onclick="event.stopPropagation();editSighting(\''+s.id+'\','+i+')" title="Edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z" stroke-linecap="round" stroke-linejoin="round"/></svg></button>'+
        '<button class="sight-del" onclick="event.stopPropagation();delSighting(\''+s.id+'\','+i+')" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/></svg></button>'+
        '</div>'+
        '</div>';
    });
    h += '</div></div>';
  }

  h += '<div class="sect"><h3 class="sect-t">Habitat</h3><p>'+s.hab+'</p></div>'+
    '<div class="sect"><h3 class="sect-t">Key Identifying Features</h3><ul>'+s.feat.map(f=>'<li>'+f+'</li>').join('')+'</ul></div>'+
    '<div class="sect"><h3 class="sect-t">Seasonal Notes</h3><p>'+s.season+'</p></div>'+
    (s.conf&&s.conf.length?'<div class="sect"><h3 class="sect-t">Could Be Confused With</h3>'+s.conf.map(c=>'<div class="conf"><div class="conf-n">'+c.sp+'</div><div class="conf-d">'+c.d+'</div></div>').join('')+'</div>':'')+
    '</div>';

  document.getElementById('di').innerHTML = h;

  fetchImgs(s.la).then(imgs => {
    const tr=document.getElementById('ct-'+s.id),dots=document.getElementById('cd-'+s.id);
    if(!imgs.length){tr.innerHTML='<div class="car-s"><div class="ph">'+s.la+'</div></div>';return;}
    // Store imgs for lightbox
    tr._lbImgs = imgs;
    tr.innerHTML=imgs.map((im,i)=>'<div class="car-s" data-lb-idx="'+i+'"><div class="skel"></div>'+(im.label?'<div class="car-lbl">'+im.label+'</div>':'')+'<div class="car-ct">'+(i+1)+' / '+imgs.length+'</div></div>').join('');
    const slides=tr.querySelectorAll('.car-s');
    imgs.forEach((im,i)=>{
      const img=new Image();img.alt=s.en+' — '+(im.label||'');
      img.onload=()=>{slides[i].querySelector('.skel')?.remove();slides[i].insertBefore(img,slides[i].firstChild);};
      img.onerror=()=>{slides[i].querySelector('.skel')?.remove();};
      img.src=im.url;
      // Click to open lightbox
      slides[i].style.cursor='zoom-in';
      slides[i].addEventListener('click',()=>openLb(imgs,i));
    });
    if(imgs.length>1) dots.innerHTML=imgs.map((_,i)=>'<div class="car-dot'+(i===0?' on':'')+'"></div>').join('');
  });

  document.getElementById('det').classList.add('on');
  document.getElementById('det').scrollTop=0;
  document.getElementById('tabs').style.display='none';
  if(pushState) history.pushState({detail:id},'','#detail/'+id);
}
function onCS(id) {
  const tr=document.getElementById('ct-'+id);if(!tr)return;
  const idx=Math.round(tr.scrollLeft/tr.offsetWidth);
  document.querySelectorAll('#cd-'+id+' .car-dot').forEach((d,i)=>d.classList.toggle('on',i===idx));
}
function closeDet() {
  document.getElementById('det').classList.remove('on');
  document.getElementById('tabs').style.display='flex';
  if(view==='browse') renderGrid();
  if(view==='fieldlog') renderML();
  history.back();
}

// ================================================================
// SIGHTINGS
// ================================================================
function openSightModal(id, editMainIdx) {
  sightModalSpecies = id;
  sightEditIdx = (editMainIdx !== undefined) ? editMainIdx : -1;
  const isEdit = sightEditIdx >= 0;
  const existing = isEdit ? sightings[sightEditIdx] : null;
  const modal = document.getElementById('sight-modal');
  modal.classList.add('on');
  document.querySelector('#sight-modal .modal-title').textContent = isEdit ? 'Edit Sighting' : 'Log Sighting';
  document.getElementById('sight-save').textContent = isEdit ? 'Update Sighting' : 'Save Sighting';
  // Set date/time
  const dt = document.getElementById('sight-dt');
  if (isEdit && existing.date) {
    const d = new Date(existing.date);
    dt.value = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')+'T'+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
  } else {
    const now = new Date();
    dt.value = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'T'+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  }
  document.getElementById('sight-note').value = (isEdit && existing.note) ? existing.note : '';
  history.pushState({view:view,modal:'sight'},'','#sighting');
  // Init map after modal is visible
  const initLat = (isEdit && existing.lat) ? existing.lat : 55.676;
  const initLng = (isEdit && existing.lng) ? existing.lng : 12.568;
  const initZoom = (isEdit && existing.lat) ? 15 : 13;
  setTimeout(()=>{
    if(sightMap){sightMap.remove();sightMap=null;}
    const mapEl = document.getElementById('sight-map');
    sightMap = L.map(mapEl,{zoomControl:false}).setView([initLat,initLng],initZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap',maxZoom:19}).addTo(sightMap);
    L.control.zoom({position:'topright'}).addTo(sightMap);
    sightMarker = L.marker([initLat,initLng],{draggable:true}).addTo(sightMap);
    // Try GPS only for new sightings without existing location
    if(!isEdit && navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos=>{
        const ll=[pos.coords.latitude,pos.coords.longitude];
        sightMap.setView(ll,15);
        sightMarker.setLatLng(ll);
      },()=>{},{enableHighAccuracy:true,timeout:8000});
    }
    sightMap.invalidateSize();
  },350);
}
function closeSightModal() {
  document.getElementById('sight-modal').classList.remove('on');
  if(sightMap){sightMap.remove();sightMap=null;}
  sightModalSpecies = null;
}
function saveSighting() {
  if(!sightModalSpecies) return;
  const dt = document.getElementById('sight-dt').value;
  const note = document.getElementById('sight-note').value.trim();
  const ll = sightMarker ? sightMarker.getLatLng() : null;
  const entry = {
    id: sightModalSpecies,
    date: dt ? new Date(dt).toISOString() : new Date().toISOString(),
    lat: ll ? ll.lat : null,
    lng: ll ? ll.lng : null,
    note: note
  };
  if (sightEditIdx >= 0) {
    sightings[sightEditIdx] = entry;
  } else {
    sightings.push(entry);
  }
  localStorage.setItem('fs-sightings', JSON.stringify(sightings));
  const reopenId = sightModalSpecies;
  closeSightModal();
  updB();
  openDet(reopenId, false);
}
function editSighting(speciesId, sortedIdx) {
  const sl = getSightingsFor(speciesId).sort((a,b)=>new Date(b.date)-new Date(a.date));
  const target = sl[sortedIdx];
  if(!target) return;
  const mainIdx = sightings.indexOf(target);
  if(mainIdx<0) return;
  openSightModal(speciesId, mainIdx);
}
function delSighting(speciesId, sortedIdx) {
  if(!confirm('Delete this sighting?')) return;
  // Get sightings for species sorted by date desc (same order as display)
  const sl = getSightingsFor(speciesId).sort((a,b)=>new Date(b.date)-new Date(a.date));
  const target = sl[sortedIdx];
  if(!target) return;
  // Find and remove from main array
  const mainIdx = sightings.indexOf(target);
  if(mainIdx>-1) sightings.splice(mainIdx,1);
  localStorage.setItem('fs-sightings',JSON.stringify(sightings));
  updB();
  openDet(speciesId, false);
}
function updB() {
  const b=document.getElementById('badge'),n=getSeenIds().length;
  if(n>0){b.textContent=n;b.style.display='flex';}else b.style.display='none';
}

// ================================================================
// FIELD LOG
// ================================================================
function renderML() {
  const el=document.getElementById('mlc'),seenIds=getSeenIds(),n=seenIds.length,total=SP.length||1,pct=(n/total*100).toFixed(0);
  let h = '<div style="padding:8px 20px 0"><div class="mc">'+n+'<small> / '+SP.length+' species spotted</small></div></div><div class="pw"><div class="pf" style="width:'+pct+'%"></div></div><p class="mhn">'+(n===0?'Log your first sighting to start tracking.':n===SP.length?"You've spotted them all!":(SP.length-n)+' more to find.')+'</p>';
  if(sightings.length && sightings.some(s=>s.lat)) {
    h += '<button class="map-all-btn" onclick="openMapModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18" stroke-width="1.8"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>View All on Map</button>';
  }
  if(!n) {
    h += '<div class="me"><p>Head outside and log your first tree sighting!</p></div>';
  } else {
    // Group by species, sort by most recent sighting
    const speciesOrder = seenIds.map(id=>{
      const sl=getSightingsFor(id);
      const latest=sl.sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
      return {id,count:sl.length,latest};
    }).sort((a,b)=>new Date(b.latest.date)-new Date(a.latest.date));
    speciesOrder.forEach(({id,count,latest})=>{
      const s=SP.find(x=>x.id===id);if(!s)return;
      const d=new Date(latest.date);
      const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
      h += '<div class="mr" onclick="openDet(\''+s.id+'\')">'+
        '<div class="mth" id="mt-'+s.id+'"><div class="skel" style="width:100%;height:100%"></div></div>'+
        '<div class="mi"><div class="mn">'+s.en+'</div><div class="mla">'+s.la+'</div>'+
        '<div class="msub">'+count+' sighting'+(count>1?'s':'')+' · Last: '+dateStr+'</div></div>'+
        '<button class="mrm" onclick="event.stopPropagation();rmSpecies(\''+s.id+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/></svg></button></div>';
    });
  }
  el.innerHTML = h;
  seenIds.forEach(id=>{const s=SP.find(x=>x.id===id);if(!s)return;const e=document.getElementById('mt-'+s.id);if(e)loadCardImg(e,s.la);});
}
function rmSpecies(id) {
  sightings = sightings.filter(s=>s.id!==id);
  localStorage.setItem('fs-sightings',JSON.stringify(sightings));
  updB(); renderML();
}

// ================================================================
// FULL MAP MODAL
// ================================================================
function openMapModal() {
  document.getElementById('map-modal').classList.add('on');
  document.getElementById('tabs').style.display='none';
  history.pushState({view:view,modal:'map'},'','#map');
  setTimeout(()=>{
    if(fullMap){fullMap.remove();fullMap=null;}
    fullMap=L.map('full-map',{zoomControl:false}).setView([55.676,12.568],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap',maxZoom:19}).addTo(fullMap);
    L.control.zoom({position:'topright'}).addTo(fullMap);
    const bounds=[];
    sightings.forEach(sg=>{
      if(!sg.lat) return;
      const s=SP.find(x=>x.id===sg.id);
      const d=new Date(sg.date);
      const dateStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      const m=L.marker([sg.lat,sg.lng]).addTo(fullMap);
      m.bindPopup('<strong>'+(s?s.en:sg.id)+'</strong><br>'+dateStr+(sg.note?'<br><em>'+sg.note+'</em>':''));
      bounds.push([sg.lat,sg.lng]);
    });
    if(bounds.length) fullMap.fitBounds(bounds,{padding:[50,50],maxZoom:14});
    fullMap.invalidateSize();
  },300);
}
function closeMapModal() {
  document.getElementById('map-modal').classList.remove('on');
  document.getElementById('tabs').style.display='flex';
  if(fullMap){fullMap.remove();fullMap=null;}
}

// ================================================================
// SMART FILTER
// ================================================================
function computeNotableTags() {
  const counts={};
  for(const s of SP) for(const tag of (s.filter.notable||[])) counts[tag]=(counts[tag]||0)+1;
  notableTags=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,25).map(([tag])=>({v:tag,t:tag}));
}

function sfMatch() {
  return SP.filter(s=>{
    const f=s.filter;
    for(const [key,val] of Object.entries(sfSel)){
      if(val===null||val===undefined) continue;
      if(Array.isArray(val)&&val.length===0) continue;
      const fv=f[key];
      if(Array.isArray(val)){
        if(Array.isArray(fv)){if(!val.some(v=>fv.includes(v)))return false;}
        else{if(!val.includes(fv))return false;}
      }else{
        if(Array.isArray(fv)){if(!fv.includes(val))return false;}
        else{if(fv!==val)return false;}
      }
    }
    return true;
  });
}

function sfMatchWithout(catId) {
  return SP.filter(s=>{
    const f=s.filter;
    for(const [key,val] of Object.entries(sfSel)){
      if(key===catId) continue;
      if(val===null||val===undefined) continue;
      if(Array.isArray(val)&&val.length===0) continue;
      const fv=f[key];
      if(Array.isArray(val)){
        if(Array.isArray(fv)){if(!val.some(v=>fv.includes(v)))return false;}
        else{if(!val.includes(fv))return false;}
      }else{
        if(Array.isArray(fv)){if(!fv.includes(val))return false;}
        else{if(fv!==val)return false;}
      }
    }
    return true;
  });
}

function sfHasSelections(){
  for(const v of Object.values(sfSel)){
    if(Array.isArray(v)&&v.length>0)return true;
    if(!Array.isArray(v)&&v!=null)return true;
  }
  return false;
}

function sfSelText(cat){
  const v=sfSel[cat.id];
  if(!v||(Array.isArray(v)&&!v.length))return null;
  if(Array.isArray(v)){
    const opts=cat.dynamic?notableTags:cat.options;
    return v.map(val=>{const o=opts.find(o=>o.v===val);return o?o.t:val;}).join(', ');
  }
  const o=cat.options.find(o=>o.v===v);
  return o?o.t:v;
}

function renderSF(){
  const matches=sfMatch();
  const hasSel=sfHasSelections();
  const el=document.getElementById('sf-content');
  const mb=document.getElementById('sf-match');
  if(hasSel){
    mb.innerHTML='<div class="sf-match-bar"><span class="sf-match-count"><strong>'+matches.length+'</strong> of '+SP.length+' species match</span><button class="sf-match-reset" onclick="sfReset()">Clear all</button></div>';
  }else{
    mb.innerHTML='';
  }
  let h='<div class="sf-wrap">';
  if(!hasSel) h+='<p class="sf-intro">Select what you can observe to narrow down species.</p>';
  for(const cat of FILTERS){
    const opts=cat.dynamic?notableTags:cat.options;
    if(!opts||!opts.length) continue;
    const isOpen=sfOpen[cat.id];
    const selText=sfSelText(cat);
    const baseMatches=sfMatchWithout(cat.id);
    h+='<div class="sf-cat'+(isOpen?' open':'')+'">';
    h+='<div class="sf-cat-head" onclick="sfToggleCat(\''+cat.id+'\')">';
    h+='<span class="sf-cat-label">'+cat.label+'</span>';
    h+='<span style="display:flex;align-items:center;gap:8px">';
    if(selText) h+='<span class="sf-cat-sel">'+selText+'</span><button class="sf-cat-clear" onclick="event.stopPropagation();sfClear(\''+cat.id+'\')">Clear</button>';
    h+='<svg class="sf-cat-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    h+='</span></div>';
    h+='<div class="sf-cat-body"><div class="sf-opts">';
    for(const opt of opts){
      const isActive=cat.multi?(sfSel[cat.id]||[]).includes(opt.v):sfSel[cat.id]===opt.v;
      const count=baseMatches.filter(s=>{
        const fv=s.filter[cat.id];
        if(Array.isArray(fv))return fv.includes(opt.v);
        return fv===opt.v;
      }).length;
      const dim=!isActive&&hasSel&&count===0;
      h+='<button class="sf-opt'+(isActive?' on':'')+(dim?' dim':'')+'" onclick="sfPick(\''+cat.id+"','"+opt.v+"',"+cat.multi+')">'+opt.t+((!isActive&&hasSel&&!dim)?'<span class="ct">'+count+'</span>':'')+'</button>';
    }
    h+='</div></div></div>';
  }
  h+='</div>';
  el.innerHTML=h;
  // Render result grid
  if(hasSel) renderCardGrid('sf-grid',matches);
  else document.getElementById('sf-grid').innerHTML='';
}

function sfToggleCat(id){sfOpen[id]=!sfOpen[id];renderSF();}

function sfPick(catId,val,multi){
  if(multi){
    if(!sfSel[catId])sfSel[catId]=[];
    const idx=sfSel[catId].indexOf(val);
    if(idx>=0)sfSel[catId].splice(idx,1);
    else sfSel[catId].push(val);
    if(!sfSel[catId].length)delete sfSel[catId];
  }else{
    if(sfSel[catId]===val)delete sfSel[catId];
    else sfSel[catId]=val;
  }
  renderSF();
}

function sfClear(catId){delete sfSel[catId];renderSF();}
function sfReset(){sfSel={};renderSF();}

// ================================================================
// LIGHTBOX — fullscreen image viewer with pinch-to-zoom
// ================================================================
let lbImgs = [], lbIdx = 0, lbScale = 1, lbPanX = 0, lbPanY = 0;
let lbPointers = new Map(), lbStartDist = 0, lbLastTap = 0;
let lbSwipeStartX = 0, lbSwipeStartY = 0, lbSwiping = false;

function openLb(imgs, startIdx) {
  lbImgs = imgs; lbIdx = startIdx || 0;
  lbScale = 1; lbPanX = 0; lbPanY = 0;
  document.getElementById('lb').classList.add('on');
  showLbImg();
  history.pushState({view:view,modal:'lightbox'},'','#lightbox');
}
function closeLb() {
  document.getElementById('lb').classList.remove('on');
  lbPointers.clear();
}
function showLbImg() {
  const im = lbImgs[lbIdx]; if(!im) return;
  const img = document.getElementById('lb-img');
  img.src = im.url; img.alt = im.label || '';
  img.style.transform = '';
  lbScale = 1; lbPanX = 0; lbPanY = 0;
  document.getElementById('lb-counter').textContent = (lbIdx+1)+' / '+lbImgs.length;
  document.getElementById('lb-label').textContent = im.label || '';
}
function lbNav(dir) {
  lbIdx = (lbIdx + dir + lbImgs.length) % lbImgs.length;
  showLbImg();
}
function lbUpdateTransform() {
  const img = document.getElementById('lb-img');
  img.style.transform = 'translate('+lbPanX+'px,'+lbPanY+'px) scale('+lbScale+')';
}

// Touch/pointer handling on lightbox body
(function(){
  const el = document.getElementById('lb-body');
  el.addEventListener('pointerdown', e => {
    el.setPointerCapture(e.pointerId);
    lbPointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    if(lbPointers.size === 1) {
      lbSwipeStartX = e.clientX; lbSwipeStartY = e.clientY; lbSwiping = true;
    }
    if(lbPointers.size === 2) {
      lbSwiping = false;
      const pts = [...lbPointers.values()];
      lbStartDist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
    }
  });
  el.addEventListener('pointermove', e => {
    if(!lbPointers.has(e.pointerId)) return;
    const prev = lbPointers.get(e.pointerId);
    lbPointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    if(lbPointers.size === 2) {
      const pts = [...lbPointers.values()];
      const dist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      const ratio = dist / lbStartDist;
      lbScale = Math.min(5, Math.max(1, lbScale * ratio));
      lbStartDist = dist;
      if(lbScale <= 1) { lbPanX = 0; lbPanY = 0; }
      lbUpdateTransform();
      e.preventDefault();
    } else if(lbPointers.size === 1 && lbScale > 1.05) {
      lbPanX += e.clientX - prev.x;
      lbPanY += e.clientY - prev.y;
      lbUpdateTransform();
      lbSwiping = false;
      e.preventDefault();
    }
  });
  el.addEventListener('pointerup', e => {
    lbPointers.delete(e.pointerId);
    if(lbPointers.size === 0 && lbSwiping && lbScale <= 1.05) {
      const dx = e.clientX - lbSwipeStartX, dy = e.clientY - lbSwipeStartY;
      const adx = Math.abs(dx), ady = Math.abs(dy);
      if(adx > 50 && adx > ady) lbNav(dx < 0 ? 1 : -1);
      else if(ady > 80 && ady > adx) closeLb();
    }
    lbSwiping = false;
    // Snap scale back if near 1
    if(lbScale < 1.05) { lbScale = 1; lbPanX = 0; lbPanY = 0; lbUpdateTransform(); }
  });
  el.addEventListener('pointercancel', e => { lbPointers.delete(e.pointerId); });
  // Double-tap to zoom
  el.addEventListener('click', e => {
    const now = Date.now();
    if(now - lbLastTap < 300) {
      if(lbScale > 1.05) { lbScale = 1; lbPanX = 0; lbPanY = 0; }
      else { lbScale = 2.5; }
      lbUpdateTransform();
    }
    lbLastTap = now;
  });
})();

// ================================================================
// LOAD SPECIES DATA
// ================================================================
async function loadSpecies(){
  try{
    const r=await fetch('species.json');
    if(!r.ok)throw new Error('HTTP '+r.status);
    const data=await r.json();
    GRP=data.groups||[];
    SP=data.species||[];
    computeNotableTags();
    document.getElementById('bsub').textContent=SP.length+' common plants of Zealand';
    renderPills();
    renderGrid();
    updB();
  }catch(e){
    document.getElementById('grid').innerHTML='<div class="loading"><p>Failed to load species data. Please refresh.</p></div>';
  }
}

// ================================================================
// INIT
// ================================================================
loadSpecies();
updB();
history.replaceState({view:'browse'},'','#browse');

if ('serviceWorker' in navigator) {
  const sw = "const C='flora-v6';self.addEventListener('install',()=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(caches.open(C).then(c=>caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k))))).then(()=>clients.claim())));self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(caches.match(e.request).then(c=>{const f=fetch(e.request).then(r=>{if(r&&r.status===200){const cl=r.clone();caches.open(C).then(ca=>ca.put(e.request,cl));}return r;}).catch(()=>c);return c||f;}));});";
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], {type: 'application/javascript'}))).catch(() => {});
}
</script>
</body>
</html>
